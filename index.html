    <style>
    @media (max-width: 600px) {
      #mainTitleTop {
        z-index: 1 !important;
        position: relative !important;
      }
      #sidebar.sidebar-glass {
        z-index: 3001 !important;
        width: 100vw !important;
        min-width: 100vw !important;
        max-width: 100vw !important;
        left: 0 !important;
        right: 0 !important;
        border-radius: 0 !important;
        border-top-right-radius: 0 !important;
        border-bottom-right-radius: 0 !important;
        border-right: none !important;
        box-shadow: none !important;
        padding: 18px 8px 18px 8px;
      }
    }
    .stepper {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 32px;
      margin: 70px 0 18px 0;
      user-select: none;
    }
    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1 1 0;
      min-width: 60px;
    }
    .step-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #fff;
      border: 3px solid #3b82f6;
      color: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.2em;
      margin-bottom: 6px;
      transition: background 0.2s, border 0.2s, color 0.2s;
    }
    .step.active .step-circle {
      background: #3b82f6;
      color: #fff;
      border-color: #3b82f6;
    }
    .step.done .step-circle {
      background: #10b981;
      color: #fff;
      border-color: #10b981;
    }
    .step-label {
      font-size: 0.98em;
      color: #3b3b3b;
      font-weight: 600;
      text-align: center;
      margin-bottom: 2px;
    }
    .step-desc {
      font-size: 0.85em;
      color: #888;
      text-align: center;
    }
    .step-connector {
      flex: 0 0 32px;
      height: 3px;
      background: #e5e7eb;
      border-radius: 2px;
      margin-bottom: 18px;
      margin-left: -16px;
      margin-right: -16px;
      z-index: 0;
    }
    .step.done ~ .step-connector {
      background: #10b981;
    }
    @media (max-width: 600px) {
      .stepper {
        gap: 4px;
        margin: 90px 0 6px 0;
        padding: 0 2vw;
        flex-wrap: wrap;
      }
      .step {
        min-width: 0;
        flex: 1 1 0;
      }
      .step-label {
        font-size: 0.78em;
        margin-bottom: 0;
      }
      .step-desc {
        font-size: 0.68em;
        margin-bottom: 0;
      }
      .step-circle {
        width: 22px;
        height: 22px;
        font-size: 0.95em;
        margin-bottom: 2px;
      }
      .step-connector {
        flex: 0 0 6px;
        height: 2px;
        margin-bottom: 4px;
        margin-left: -2px;
        margin-right: -2px;
      }
    }
    </style>
  <!-- Main Title above stepper -->
  <div id="mainTitleTop" style="width:100vw;text-align:center;margin:18px 0 0 0;z-index:3000;position:relative;">
    <h1 style="text-align:center;margin:0 0 10px 0;font-size:2.2em;font-weight:800;background:linear-gradient(90deg,#3b82f6,#10b981);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:1px;">Mỗi ngày 5 từ tiếng Anh mới</h1>
  </div>
  <!-- Donut progress card (giữ nguyên vị trí) -->
  <!-- Stepper progress bar: chuyển xuống dưới donut progress -->
  <div class="stepper" id="learningStepper">
    <div class="step active" data-step="1">
      <div class="step-circle">1</div>
      <div class="step-label">Học nghĩa</div>
      <div class="step-desc">Xem & ghi nhớ từ mới</div>
    </div>
    <div class="step-connector"></div>
    <div class="step" data-step="2">
      <div class="step-circle">2</div>
      <div class="step-label">Luyện tập</div>
      <div class="step-desc">Làm bài trắc nghiệm</div>
    </div>
    <div class="step-connector"></div>
    <div class="step" data-step="3">
      <div class="step-circle">3</div>
      <div class="step-label">Hoàn thành</div>
      <div class="step-desc">Đánh dấu hoàn thành</div>
    </div>
  </div>
  <script>
  // Âm thanh trả lời đúng
  const correctSound = new Audio('sounds/news-ting-6832.mp3');
  correctSound.volume = 0.5;
  // Âm thanh trả lời sai
  const wrongSound = new Audio('sounds/error-12662.mp3');
  wrongSound.volume = 0.7;
    // Stepper progress logic: highlight step based on tab
    // Stepper trạng thái backend: 1=đang học nghĩa, 2=đang luyện tập, 3=đã hoàn thành
    // Stepper progress logic: highlight step based on tab and backend state
    function getCurrentStep() {
  // Chỉ khi đã hoàn thành ngày học (bấm nút hoàn thành), mới active bước 3
  if (localStorage.getItem('md5t_day_done') === '1') return 3;
  // Nếu tab luyện tập đang mở (id=tab-practice không có class hidden) thì step 2 active
  const tabPractice = document.getElementById('tab-practice');
  if (tabPractice && !tabPractice.classList.contains('hidden')) return 2;
  // Nếu tab đã học đang mở mà chưa hoàn thành, vẫn giữ step 2 (đang luyện tập)
  const tabLearned = document.getElementById('tab-learned');
  if (tabLearned && !tabLearned.classList.contains('hidden')) return 2;
  // Mặc định là bước 1
  return 1;
    }

    function updateStepper() {
      const stepper = document.getElementById('learningStepper');
      if (!stepper) return;
      const steps = stepper.querySelectorAll('.step');
      // Xóa hết trạng thái
      steps.forEach(step => step.classList.remove('active','done'));
      const currentStep = getCurrentStep();
      // Đánh dấu các bước đã hoàn thành
      for (let i = 0; i < steps.length; i++) {
        if (i+1 < currentStep) steps[i].classList.add('done');
      }
      // Đánh dấu bước hiện tại là active
      const activeStepDiv = stepper.querySelector('.step[data-step="'+currentStep+'"]');
      if (activeStepDiv) activeStepDiv.classList.add('active');
    }

    // Đảm bảo updateStepper luôn chạy khi tab chuyển bằng phím tắt, click, hoặc code
    function setupStepperObservers() {
      // Update on DOMContentLoaded
      document.addEventListener('DOMContentLoaded', function() {
        updateStepper();
        // Tab click event
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', ()=>{
            // Khi chuyển tab, nếu chưa hoàn thành thì xóa trạng thái hoàn thành
            if (localStorage.getItem('md5t_day_done') !== '1') {
              localStorage.removeItem('md5t_day_done');
            }
            setTimeout(updateStepper, 20);
          });
        });
        // Update on tab section visibility change
        ['tab-lesson','tab-practice','tab-learned'].forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            new MutationObserver(updateStepper).observe(el, { attributes: true, attributeFilter: ['class'] });
          }
        });
        // Khi bấm nút hoàn thành ngày học thì set trạng thái step 3
        const finishDayBtn = document.getElementById('finishDay');
        if (finishDayBtn) {
          finishDayBtn.addEventListener('click', function() {
            localStorage.setItem('md5t_day_done', '1');
            setTimeout(updateStepper, 10);
          });
        }
        // Khi chọn lại ngày mới thì reset stepper về bước 1
        const resetTodayBtn = document.getElementById('resetToday');
        if (resetTodayBtn) {
          resetTodayBtn.addEventListener('click', function() {
            localStorage.removeItem('md5t_day_done');
            setTimeout(updateStepper, 10);
          });
        }
      });
    }
    setupStepperObservers();
  </script>
    <style>
    @media (max-width: 600px) {
      body {
        background: #10182a;
      }
      #mainTitleTop {
        margin-top: 12px !important;
        margin-bottom: 10px !important;
        padding: 0 2vw;
      }
      #mainTitleTop h1 {
        font-size: 1.45em !important;
        margin: 0 0 10px 0 !important;
        letter-spacing: 1.5px;
        line-height: 1.2;
      }
      .sidebar-toggle-btn {
        top: 60px !important;
        left: 12px !important;
        width: 38px;
        height: 38px;
        font-size: 18px;
        z-index: 2100;
      }
      .stepper {
        gap: 10px;
        margin: 10px 0 18px 0 !important;
        padding: 0 2vw;
        flex-wrap: wrap;
        justify-content: center;
      }
      .step {
        min-width: 0;
        flex: 1 1 0;
        padding: 0 2px;
      }
      .step-label {
        font-size: 1em;
        margin-bottom: 0;
        font-weight: 700;
        color: #fff;
      }
      .step-desc {
        font-size: 0.78em;
        margin-bottom: 0;
        color: #b5c6e0;
      }
      .step-circle {
        width: 32px;
        height: 32px;
        font-size: 1.15em;
        margin-bottom: 2px;
        border-width: 2.5px;
      }
      .step-connector {
        flex: 0 0 8px;
        height: 2.5px;
        margin-bottom: 4px;
        margin-left: -2px;
        margin-right: -2px;
      }
      .donut-progress-wrap {
        margin-top: 18px;
        margin-bottom: 10px;
        display: flex;
        justify-content: center;
      }
      .donut-progress-card {
        min-width: 0;
        padding: 16px 4vw 12px 4vw;
        border-radius: 16px;
        box-shadow: 0 2px 12px #0003;
        background: #181e2a;
      }
      .donut-numbers {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 6px;
      }
      .donut-numbers .donut-label {
        font-size: 1em;
        padding: 2px 8px;
        margin-right: 4px;
      }
      .donut-numbers #learnedCount {
        font-size: 1.3em;
      }
      .donut-numbers .donut-sep {
        font-size: 1em;
      }
      .donut-numbers #totalWordsCount {
        font-size: 1em;
      }
      .main-nav {
        gap: 8px;
        margin-bottom: 16px;
      }
      .main-nav .tab {
        font-size: 1em;
        padding: 10px 12px;
        border-radius: 12px;
        margin-bottom: 4px;
      }
      .main-toolbar {
        padding: 10px 4vw 10px 4vw;
        border-radius: 12px;
        gap: 12px;
        margin-bottom: 16px;
      }
      .lesson-grid {
        grid-template-columns: 1fr;
        gap: 14px;
        margin-top: 12px;
      }
      .card {
        min-width: 0;
        padding: 14px 8px;
        border-radius: 14px;
        box-shadow: 0 2px 12px #0002;
      }
      .btn, .btn.primary, .btn.success, .btn.warn {
        font-size: 1em;
        padding: 12px 0;
        border-radius: 12px;
        width: 100%;
        margin-bottom: 8px;
      }
      .toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      .footer {
        font-size: 0.9em;
        padding: 1.2em 0;
      }
    }
    </style>
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mỗi ngày 5 từ tiếng Anh mới</title>
  <style>
    /* --- Extra Animations & Vibrant Effects --- */
    /* Rainbow border animation for cards */
    @keyframes rainbowBorder {
      0% { box-shadow: 0 0 0 0 #3b82f6, 0 0 0 0 #10b981, 0 0 0 0 #f59e0b, 0 0 0 0 #ef4444; }
      25% { box-shadow: 0 0 0 4px #3b82f6, 0 0 0 0 #10b981, 0 0 0 0 #f59e0b, 0 0 0 0 #ef4444; }
      50% { box-shadow: 0 0 0 0 #3b82f6, 0 0 0 4px #10b981, 0 0 0 0 #f59e0b, 0 0 0 0 #ef4444; }
      75% { box-shadow: 0 0 0 0 #3b82f6, 0 0 0 0 #10b981, 0 0 0 4px #f59e0b, 0 0 0 0 #ef4444; }
      100% { box-shadow: 0 0 0 0 #3b82f6, 0 0 0 0 #10b981, 0 0 0 0 #f59e0b, 0 0 0 4px #ef4444; }
    }
    @keyframes cardFloat {
      0% { transform: translateY(0) scale(1) rotate(0deg); box-shadow: 0 8px 32px 0 rgba(255, 186, 115, 0.18), 0 2px 8px 0 rgba(255, 154, 139, 0.10); }
      50% { transform: translateY(-10px) scale(1.025) rotate(-1deg); box-shadow: 0 16px 48px 0 rgba(255, 154, 139, 0.22), 0 8px 24px 0 rgba(255, 186, 115, 0.18); }
      100% { transform: translateY(0) scale(1) rotate(0deg); box-shadow: 0 8px 32px 0 rgba(255, 186, 115, 0.18), 0 2px 8px 0 rgba(255, 154, 139, 0.10); }
    }
    @keyframes cardGlow {
      0%,100% { box-shadow: 0 0 24px 0 #ffd6a5cc, 0 8px 32px 0 rgba(255, 186, 115, 0.18); }
      50% { box-shadow: 0 0 48px 8px #ffb385cc, 0 16px 48px 0 rgba(255, 154, 139, 0.22); }
    }
    .card {
      background: linear-gradient(135deg, rgba(255,255,255,0.18) 0%, rgba(255,255,255,0.10) 100%);
      border-radius: 22px;
      border: 2.5px solid #ffd6a5;
      box-shadow: 0 8px 32px 0 rgba(255, 186, 115, 0.18), 0 2px 8px 0 rgba(255, 154, 139, 0.10);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: transform 0.18s cubic-bezier(.4,2,.6,1), box-shadow 0.18s, border-color 0.18s;
      animation: fadeInUp 0.6s ease forwards, rainbowBorder 3s linear infinite, cardFloat 4.5s ease-in-out infinite, cardGlow 3.5s ease-in-out infinite;
      position: relative;
      overflow: hidden;
    }
    .card::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
      border-radius: 22px;
      background: linear-gradient(120deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%);
      z-index: 1;
    }
    .card:hover {
      transform: scale(1.035) translateY(-4px) rotate(-1deg);
      box-shadow: 0 12px 36px 0 rgba(255, 154, 139, 0.18), 0 4px 16px 0 rgba(255, 186, 115, 0.18);
      border-color: #ffb385;
    }
    .card h3 {
      color: #ff9a8b;
      text-shadow: 0 2px 8px #fff6;
    }
    /* Button pulse animation */
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 var(--primary); }
      70% { box-shadow: 0 0 0 10px rgba(59,130,246,0); }
      100% { box-shadow: 0 0 0 0 rgba(59,130,246,0); }
    }
    .btn.primary, .btn.success, .btn.warn {
      animation: pulse 2s infinite;
    }
    /* Floating glowing effect for .pill */
    @keyframes floatGlow {
      0% { filter: drop-shadow(0 0 0px #3b82f6); transform: translateY(0); }
      50% { filter: drop-shadow(0 0 8px #10b981); transform: translateY(-6px); }
      100% { filter: drop-shadow(0 0 0px #3b82f6); transform: translateY(0); }
    }
    .pill {
      animation: floatGlow 2.5s ease-in-out infinite;
    }
    /* Toast pop-in animation */
    @keyframes toastPop {
      0% { opacity: 0; transform: translateY(-60px) scale(0.98) rotate(-3deg); }
      60% { opacity: 1; transform: translateY(8px) scale(1.04) rotate(2deg); }
      100% { opacity: 1; transform: translateY(0) scale(1) rotate(0); }
    }
    #toast.show {
      animation: toastPop 0.7s cubic-bezier(0.4,0,0.2,1);
    }
    /* Quiz choice hover pop */
    .choice:hover {
      animation: pop 0.25s;
    }
    @keyframes pop {
      0% { transform: scale(1); }
      60% { transform: scale(1.12); }
      100% { transform: scale(1.04); }
    }
    /* Sparkle effect for .user-info-highlight */
    .user-info-highlight {
      position: relative;
      overflow: visible;
    }
    .user-info-highlight::after {
      content: '';
      position: absolute;
      top: -8px; left: -8px; right: -8px; bottom: -8px;
      pointer-events: none;
      background: radial-gradient(circle, #fff6 0%, transparent 70%);
      opacity: 0.5;
      animation: sparkle 2.5s infinite linear;
    }
    @keyframes sparkle {
      0%,100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
    /* Modal pop-in */
    #authModalContent {
      animation: popupIn 0.4s cubic-bezier(0.4,0,0.2,1);
    }
    /* Details expand animation */
    details[open] > summary ~ * {
      animation: fadeInUp 0.5s;
    }
    /* Animated gradient background for body - SOFTER, EYE-FRIENDLY TONE */
    @keyframes bgMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    body {
      background: linear-gradient(120deg, #fffde4, #ffe9b3, #ffd6a5, #ffb385, #ff9a8b, #fffde4);
      background-size: 1200% 1200%;
      animation: bgMove 30s ease-in-out infinite;
    }
    /* Subtle fade-in for all main sections */
    main > section {
      opacity: 0;
      animation: fadeInUp 1.2s forwards;
      animation-delay: 0.2s;
    }
    main > section:nth-child(2) { animation-delay: 0.4s; }
    main > section:nth-child(3) { animation-delay: 0.6s; }
    main > section:nth-child(4) { animation-delay: 0.8s; }
    :root{
      --bg:#0f172a;      /* slate-900 */
      --card:#111827ee;  /* gray-900 */
      --text:#e5e7eb;    /* gray-200 */
      --muted:#94a3b8;   /* slate-400 */
      --accent:#22c55e;  /* green-500 */
      --primary:#60a5fa; /* blue-400 */
      --danger:#ef4444;  /* red-500 */
      --warning:#f59e0b; /* amber-500 */
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, #1f2937, transparent),
                  radial-gradient(1200px 800px at 110% 10%, #0b3b70, transparent),
                  var(--bg);
      min-height:100vh; overflow-x:hidden;
    }
    header{
      padding:24px 16px; position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);
      background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.6));
      border-bottom:1px solid #1f2937;
    }
    .container{max-width:1000px; margin:0 auto; padding:0 12px}
    h1{margin:0; font-size:clamp(20px,3.4vw,36px); letter-spacing:.2px}
    .sub{color:var(--muted); font-size:14px}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:8px}
    .pill{padding:6px 10px; border:1px solid #374151; border-radius:999px; color:var(--muted); font-size:12px}
    nav{display:flex; gap:8px; margin-top:14px}
    .tab{border:1px solid #334155; background:#0b1220; color:#cbd5e1; padding:10px 14px; border-radius:10px; cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#0a1a34,#0b1220); border-color:#3b82f6; color:white; box-shadow:0 0 0 2px #1d4ed8 inset}
    main{padding:24px 0 48px}

    .lesson-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:14px}
    .card{background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h3{margin:0 0 6px; font-size:22px}
    .phonetic{color:#a5b4fc}
    .meaning{margin-top:10px; padding:10px; border-radius:12px; background:#0b1220; border:1px dashed #334155; color:#e2e8f0; display:flex; justify-content:space-between; align-items:center}
    .meaning button{margin-left:10px}

    .btn{appearance:none; border:1px solid #334155; color:#e5e7eb; background:#0b1220; padding:10px 12px; border-radius:12px; cursor:pointer}
    .btn:hover{border-color:#475569}
    .btn.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8); border:none}
    .btn.success{background:linear-gradient(180deg,#22c55e,#16a34a); border:none}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706); border:none}
    .btn.ghost{background:transparent}

    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:14px 0}
    .muted{color:var(--muted)}

    .list{display:grid; gap:10px}
    details{background:var(--card); border:1px solid #1f2937; border-radius:14px; padding:10px 12px}
    summary{cursor:pointer; font-weight:600}
    .tag{display:inline-block; margin:6px 6px 0 0; padding:6px 10px; background:#0b1220; border:1px solid #334155; border-radius:999px; font-size:12px}

    .quiz{max-width:700px}
    .q-card{background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px}
    .choices{display:grid; gap:10px; margin-top:10px}
    .choice{padding:10px 12px; border:1px solid #334155; border-radius:12px; cursor:pointer; background:#0b1220}
    .choice.correct{border-color:var(--accent)}
    .choice.wrong{border-color:var(--danger)}

    .footer{margin-top:28px; color:var(--muted); font-size:12px; text-align:center}
    .right{margin-left:auto}
    .hidden{display:none}
    input[type="search"]{background:#0b1220; border:1px solid #334155; color:#e5e7eb; border-radius:10px; padding:10px; min-width:220px}

    /* <CHANGE> Modern toast notification styling */
    #toast {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 2000;
      min-width: 320px;
      max-width: 400px;
      background: rgba(40, 40, 40, 0.95);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(-60px) scale(0.98);
      transition: opacity 0.35s cubic-bezier(0.4,0,0.2,1), transform 0.35s cubic-bezier(0.4,0,0.2,1);
    }

    #toast.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0) scale(1);
    }

    .toast-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: bold;
      color: white;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .toast-icon.success {
      background: linear-gradient(135deg, #22c55e, #16a34a);
    }

    .toast-icon.error {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .toast-icon.warning {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .toast-icon.info {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    .toast-content {
      flex: 1;
      min-width: 0;
    }

    .toast-title {
      font-size: 15px;
      font-weight: 600;
      color: #ffffff;
      margin: 0 0 4px 0;
      line-height: 1.3;
    }

    .toast-message {
      font-size: 14px;
      color: #d1d5db;
      margin: 0;
      line-height: 1.4;
      word-wrap: break-word;
    }

    @media (max-width: 480px) {
      #toast {
        left: 16px;
        right: 16px;
        min-width: auto;
        max-width: none;
      }
    }
    :root{
      --bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      --card: rgba(30, 41, 59, 0.8);
      --card-hover: rgba(51, 65, 85, 0.9);
      --text: #f1f5f9;
      --text-secondary: #cbd5e1;
      --muted: #94a3b8;
      --accent: #10b981;
      --accent-hover: #059669;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #22c55e;
      --border: rgba(148, 163, 184, 0.2);
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 20px 40px -10px rgba(0, 0, 0, 0.4);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      color: var(--text);
      background: var(--bg);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.6;
    }

    /* Enhanced Header */
    header {
      padding: 2rem 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
      background: rgba(15, 23, 42, 0.9);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    h1 {
      font-family: 'Poppins', sans-serif;
      font-size: clamp(1.8rem, 4vw, 2.5rem);
      font-weight: 700;
      background: linear-gradient(135deg, #3b82f6, #10b981);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1rem;
      text-align: center;
    }

    .row {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 1.5rem;
    }

    .pill {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: 50px;
      color: var(--text-secondary);
      font-size: 0.875rem;
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .pill:hover {
      background: rgba(51, 65, 85, 0.8);
      transform: translateY(-2px);
    }

    /* Enhanced Navigation */
    nav {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .tab {
      border: 1px solid var(--border);
      background: rgba(30, 41, 59, 0.6);
      color: var(--text-secondary);
      padding: 0.75rem 1.25rem;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .tab::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }

    .tab:hover::before {
      left: 100%;
    }

    .tab:hover {
      background: var(--card-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .tab.active {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-color: var(--primary);
      color: white;
      box-shadow: var(--shadow);
    }

    .right {
      margin-left: auto;
    }

    main {
      padding: 2rem 0 3rem;
    }

    /* Enhanced Cards */
    .lesson-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .card:hover {
      background: var(--card-hover);
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .card:hover::before {
      opacity: 1;
    }

    .card h3 {
      font-family: 'Poppins', sans-serif;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    .phonetic {
      color: #a5b4fc;
      font-style: italic;
      margin-bottom: 1rem;
      font-size: 1rem;
    }

    .meaning {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px dashed var(--border);
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    /* Enhanced Buttons */
    .btn {
      appearance: none;
      border: 1px solid var(--border);
      color: var(--text);
      background: rgba(30, 41, 59, 0.8);
      padding: 0.75rem 1.25rem;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }

    .btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      border: none;
      color: white;
    }

    .btn.success {
      background: linear-gradient(135deg, var(--success), var(--accent-hover));
      border: none;
      color: white;
    }

    .btn.warn {
      background: linear-gradient(135deg, var(--warning), #d97706);
      border: none;
      color: white;
    }

    .btn.ghost {
      background: transparent;
      border-color: var(--border);
    }

    /* Enhanced Toolbar */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin: 2rem 0;
      padding: 1.5rem;
      background: rgba(30, 41, 59, 0.4);
      border-radius: 16px;
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }

    .muted {
      color: var(--muted);
      font-size: 0.875rem;
    }

    /* Enhanced Lists */
    .list {
      display: grid;
      gap: 1rem;
      margin-top: 2rem;
    }

    details {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1rem 1.25rem;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    details:hover {
      background: var(--card-hover);
      box-shadow: var(--shadow);
    }

    summary {
      cursor: pointer;
      font-weight: 600;
      padding: 0.5rem 0;
      color: var(--text);
      transition: color 0.3s ease;
    }

    summary:hover {
      color: var(--primary);
    }

    .tag {
      display: inline-block;
      margin: 0.5rem 0.5rem 0 0;
      padding: 0.5rem 1rem;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid var(--border);
      border-radius: 50px;
      font-size: 0.75rem;
      transition: all 0.3s ease;
    }

    .tag:hover {
      background: var(--card-hover);
      transform: translateY(-1px);
    }

    /* Enhanced Quiz */
    .quiz {
      max-width: 800px;
      margin: 0 auto;
    }

    .q-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .choices {
      display: grid;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .choice {
      padding: 1rem 1.25rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.8);
      color: var(--text);
      transition: all 0.3s ease;
      text-align: left;
    }

    .choice:hover {
      background: var(--card-hover);
      border-color: var(--primary);
      transform: translateX(5px);
    }

    .choice.correct {
      border-color: var(--success);
      background: rgba(34, 197, 94, 0.2);
    }

    .choice.wrong {
      border-color: var(--danger);
      background: rgba(239, 68, 68, 0.2);
    }

    /* Enhanced Modal */
    #authModal {
      backdrop-filter: blur(10px);
    }

    #authModalContent {
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(20px);
    }

    /* Enhanced Form Elements */
    input[type="search"], input[type="email"], input[type="password"] {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      min-width: 250px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    input[type="search"]:focus, input[type="email"]:focus, input[type="password"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Enhanced Toast */
    #toast {
      background: var(--card) !important;
      border: 1px solid var(--border);
      backdrop-filter: blur(20px);
      box-shadow: var(--shadow-lg);
    }

    /* Footer */
    .footer {
      margin-top: 3rem;
      color: var(--muted);
      font-size: 0.875rem;
      text-align: center;
      padding: 2rem;
      border-top: 1px solid var(--border);
      background: rgba(30, 41, 59, 0.3);
    }

    .hidden {
      display: none !important;
    }

    /* Confirm popup styles */
    #logoutConfirmPopup {
      position: fixed;
      z-index: 3000;
      top: 0; left: 0; width: 100vw; height: 100vh;
      display: none;
    }
    #logoutConfirmPopup .confirm-overlay {
      position: absolute;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.35);
    }
    #logoutConfirmPopup .confirm-box {
      position: absolute;
      top: 50%; left: 50%; transform: translate(-50%,-50%);
      background: #fff;
      color: #222;
      border-radius: 14px;
      min-width: 320px;
      box-shadow: 0 8px 32px #0005;
      padding: 32px 28px 22px 28px;
      text-align: center;
      animation: popupIn .25s;
    }
    #logoutConfirmPopup .confirm-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    #logoutConfirmPopup .confirm-msg {
      font-size: 16px;
      margin-bottom: 18px;
    }
    #logoutConfirmPopup .confirm-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
    }
    @keyframes popupIn {
      from { opacity: 0; transform: translate(-50%,-60%) scale(0.95); }
      to   { opacity: 1; transform: translate(-50%,-50%) scale(1); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 0 0.5rem;
      }
      
      .lesson-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .toolbar .btn {
        width: 100%;
        text-align: center;
      }
      
      nav {
        flex-direction: column;
      }
      
      .tab {
        width: 100%;
        text-align: center;
      }
    }

    /* Animation for page load */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card, .toolbar, details {
      animation: fadeInUp 0.6s ease forwards;
    }

    .card:nth-child(2) { animation-delay: 0.1s; }
    .card:nth-child(3) { animation-delay: 0.2s; }
    .card:nth-child(4) { animation-delay: 0.3s; }
    .card:nth-child(5) { animation-delay: 0.4s; }

  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
</head>
<style>
html, body {
  max-width: 100vw;
  overflow-x: hidden;
  overscroll-behavior-x: contain;
}
</style>
<body>
  <!-- Main Title at the very top -->
  <div id="mainTitleTop" style="width:100vw;text-align:center;margin:18px 0 0 0;z-index:3000;position:relative;">

  </div>
  <!-- Sidebar toggle button -->
  <button id="sidebarToggle" class="sidebar-toggle-btn">
    <span id="sidebarToggleIcon">☰</span>
  </button>
    <style>
    .sidebar-toggle-btn {
      position: fixed;
      top: 28px;
      left: 18px;
      z-index: 9999 !important;
      background: linear-gradient(135deg,#ffb385,#ff9a8b);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      box-shadow: 0 2px 8px #0002;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      transition: background 0.2s;
      outline: none;
      pointer-events: auto !important;
    }
    @media (max-width: 600px) {
      .sidebar-toggle-btn {
        position: absolute;
        top: 54px;
        left: 12px;
        width: 38px;
        height: 38px;
        font-size: 18px;
        z-index: 2100;
      }
    }
    </style>
  <!-- Sidebar -->
  <aside id="sidebar" class="hidden sidebar-glass">
</head>
<style>
  /* Sidebar glassmorphism & animation */
  #sidebar.sidebar-glass {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    width: 320px;
    max-width: 90vw;
    z-index: 10000;
    background: linear-gradient(120deg, rgba(255, 255, 255, 0) 0%, rgba(255, 185, 115, 0) 100%);
    backdrop-filter: blur(22px) saturate(1.2);
    -webkit-backdrop-filter: blur(22px) saturate(1.2);
    box-shadow: 8px 0 32px 0 #ffb38544, 0 8px 32px 0 #ff9a8b00;
    border-top-right-radius: 32px;
    border-bottom-right-radius: 32px;
    border-right: 2.5px solid #180c3bcc;
    border-left: none;
    transition: transform 0.45s cubic-bezier(.4,2,.6,1), box-shadow 0.3s, background 0.3s;
    transform: translateX(-100%);
    display: flex;
    flex-direction: column;
    padding: 32px 24px 24px 24px;
    gap: 32px;
    opacity: 0.98;
    animation: sidebarFadeIn 0.7s cubic-bezier(.4,2,.6,1);
  }
  #sidebar.sidebar-glass:not(.hidden) {
    display: flex !important;
    box-shadow: 16px 0 48px 0 #00000066, 0 16px 48px 0 #ff9a8b33;
    background: linear-gradient(120deg, rgba(255, 255, 255, 0) 0%, rgba(255, 185, 115, 0.027) 100%);
    opacity: 1;
    animation: sidebarSlideIn 0.5s cubic-bezier(.4,2,.6,1);
  }
  @keyframes sidebarSlideIn {
    from { transform: translateX(-120%); opacity: 0.7; }
    to   { transform: translateX(0); opacity: 1; }
  }
  @keyframes sidebarFadeIn {
    from { opacity: 0; }
    to   { opacity: 0.98; }
  }
  #sidebar.sidebar-glass .btn {
    box-shadow: 0 2px 8px #ffb38522;
    transition: background 0.2s, box-shadow 0.2s, transform 0.18s;
  }
  #sidebar.sidebar-glass .btn:hover {
    background: linear-gradient(90deg, #ffb385, #ff9a8b);
    color: #fff;
    transform: scale(1.04) translateY(-2px);
    box-shadow: 0 4px 16px #ffb38544;
  }
  #sidebar.sidebar-glass h2 {
    background: linear-gradient(90deg, #ffb385, #ff9a8b);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 700;
    letter-spacing: 1px;
    text-shadow: 0 2px 8px #fff6;
  }
  #sidebar.sidebar-glass [id^="sidebar"] {
    text-shadow: 0 1px 4px #fff4;
  }
  #sidebar.sidebar-glass #sidebarClose {
    transition: color 0.2s, transform 0.18s;
  }
  #sidebar.sidebar-glass #sidebarClose:hover {
    color: #ffb385;
    transform: scale(1.2) rotate(8deg);
  }
  #sidebar.sidebar-glass::-webkit-scrollbar {
    width: 8px;
    background: transparent;
  }
  #sidebar.sidebar-glass::-webkit-scrollbar-thumb {
    background: #ffd6a555;
    border-radius: 8px;
  }
  @media (max-width: 600px) {
    #sidebar.sidebar-glass {
      width: 100vw !important;
      min-width: 100vw !important;
      max-width: 100vw !important;
      left: 0 !important;
      right: 0 !important;
      border-radius: 0 !important;
      border-top-right-radius: 0 !important;
      border-bottom-right-radius: 0 !important;
      border-right: none !important;
      box-shadow: none !important;
      padding: 18px 8px 18px 8px;
    }
  }
</style>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <h2 style="margin:0;font-size:1.5rem;color:#ff9a8b;font-family:'Poppins',sans-serif;">Thông tin</h2>
      <button id="sidebarClose" style="background:none;border:none;font-size:2rem;color:#ff9a8b;cursor:pointer;">&times;</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:18px;">
      <div class="pill" id="todayLabel" style="align-self:flex-start;background:rgba(255,186,115,0.18);color:#ff9a8b;font-weight:600;font-size:1.08em;margin-bottom:2px;box-shadow:0 2px 8px #ffb38522;">Hôm nay: —</div>

      <div style="font-size:1.1rem;color:#ffb385;display:flex;align-items:center;gap:8px;">
        <span style="font-size:1.3em;">📈</span> Tiến độ: <span id="sidebarProgress">0</span> / <span id="sidebarTotalWords">0</span> từ
      </div>
      <div style="font-size:1.1rem;color:#ffb385;display:flex;align-items:center;gap:8px;">
        <span style="font-size:1.3em;">🔥</span> Ngày liên tiếp: <span id="sidebarStreak">0</span>
      </div>
      <div id="sidebarUserInfo" style="font-size:1.1rem;color:#ff9a8b;display:none;align-items:center;gap:8px;">
        <span style="font-size:1.3em;">👤</span> <span id="sidebarUserEmail"></span>
      </div>
      <button id="sidebarLoginBtn" class="btn primary" style="width:100%;margin-top:10px;">Đăng nhập</button>
      <button id="sidebarLogoutBtn" class="btn warn" style="width:100%;margin-top:10px;display:none;">Đăng xuất</button>
    </div>
  </aside>
  <header>
  <script>
    // Sidebar logic
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarClose = document.getElementById('sidebarClose');
    const sidebarProgress = document.getElementById('sidebarProgress');
    const sidebarTotalWords = document.getElementById('sidebarTotalWords');
    const sidebarStreak = document.getElementById('sidebarStreak');
    const sidebarUserInfo = document.getElementById('sidebarUserInfo');
    const sidebarUserEmail = document.getElementById('sidebarUserEmail');
    const sidebarLoginBtn = document.getElementById('sidebarLoginBtn');
    const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');
    const sidebarToggleIcon = document.getElementById('sidebarToggleIcon');
    function openSidebar() {
      sidebar.classList.remove('hidden');
      sidebar.style.removeProperty('display');
      sidebar.style.removeProperty('transform');
      sidebar.style.display = 'flex';
      sidebar.style.transform = 'translateX(0)';
      sidebarToggle.style.display = 'none';
    }
    function closeSidebar() {
      sidebar.style.transform = 'translateX(-100%)';
      setTimeout(() => {
        sidebar.classList.add('hidden');
        sidebar.style.display = 'none';
        sidebar.style.transform = '';
      }, 350);
      sidebarToggle.style.display = 'flex';
    }
    sidebarToggle.onclick = openSidebar;
    sidebarClose.onclick = closeSidebar;
    // Sync sidebar info
  function updateSidebarInfo() {
      // Defensive: only update if elements exist
      // Cập nhật donut progress
      const learnedCount = (() => {
        const learned = JSON.parse(localStorage.getItem('md5t_learned')||'[]');
        if (Array.isArray(learned)) return learned.reduce((acc,g)=>acc+g.items.length,0);
        return 0;
      })();
      const totalWords = window.CORPUS ? window.CORPUS.length : 0;
      const donut = document.getElementById('donutProgress');
      const learnedCountEl = document.getElementById('learnedCount');
      const totalWordsCountEl = document.getElementById('totalWordsCount');
      if (donut && totalWords > 0) {
        const percent = Math.min(learnedCount/totalWords, 1);
        const circleLen = 2 * Math.PI * 24; // r=24
        donut.setAttribute('stroke-dasharray', circleLen);
        donut.setAttribute('stroke-dashoffset', circleLen * (1-percent));
        donut.setAttribute('stroke','#6366f1');
        donut.style.transition = 'stroke-dashoffset 0.7s cubic-bezier(.4,2,.6,1)';
      }
      if (learnedCountEl) learnedCountEl.textContent = learnedCount;
      if (totalWordsCountEl) totalWordsCountEl.textContent = totalWords;
      // ...existing code...
      // Ẩn tiến độ và ngày liên tiếp nếu chưa đăng nhập
      const progressRow = sidebarProgress?.parentElement;
      const streakRow = sidebarStreak?.parentElement;
      let userEmail = '';
      if (window.auth && window.auth.currentUser && window.auth.currentUser.email) {
        userEmail = window.auth.currentUser.email;
      }
      if (sidebarProgress && sidebarTotalWords && sidebarStreak && progressRow && streakRow) {
        if (userEmail) {
          progressRow.style.display = '';
          streakRow.style.display = '';
          const learned = JSON.parse(localStorage.getItem('md5t_learned')||'[]');
          const totalWords = window.CORPUS ? window.CORPUS.length : 0;
          const streak = JSON.parse(localStorage.getItem('md5t_streak')||'0');
          let learnedCount = 0;
          if (Array.isArray(learned)) learnedCount = learned.reduce((acc,g)=>acc+g.items.length,0);
          sidebarProgress.textContent = learnedCount;
          sidebarTotalWords.textContent = totalWords;
          sidebarStreak.textContent = streak;
        } else {
          progressRow.style.display = 'none';
          streakRow.style.display = 'none';
        }
      }
      // User info
      if (sidebarUserInfo && sidebarUserEmail && sidebarLoginBtn && sidebarLogoutBtn) {
        // Try to get Firebase user
        let userEmail = '';
        if (window.auth && window.auth.currentUser && window.auth.currentUser.email) {
          userEmail = window.auth.currentUser.email;
        }
        if (userEmail) {
          sidebarUserInfo.style.display = 'flex';
          sidebarUserEmail.textContent = userEmail;
          sidebarLoginBtn.style.display = 'none';
          sidebarLogoutBtn.style.display = 'block';
        } else {
          sidebarUserInfo.style.display = 'none';
          sidebarUserEmail.textContent = '';
          sidebarLoginBtn.style.display = 'block';
          sidebarLogoutBtn.style.display = 'none';
        }
      }
    }
    // Open login modal from sidebar
    if (sidebarLoginBtn) {
      sidebarLoginBtn.onclick = function() {
        closeSidebar();
        // Open login modal if available
        const openAuthBtn = document.getElementById('openAuth');
        if (openAuthBtn) openAuthBtn.click();
      };
    }
    if (sidebarLogoutBtn) {
      sidebarLogoutBtn.onclick = function() {
        closeSidebar();
        showConfirmLogout(async () => {
          if (window.auth && typeof window.auth.signOut === 'function') {
            await window.auth.signOut();
            showToast('Đăng xuất thành công!', '','success');
            setTimeout(()=>location.reload(), 800);
          }
        });
      };
    }
    // Update sidebar info on page load and when switching tabs
    document.addEventListener('DOMContentLoaded', updateSidebarInfo);
    setInterval(updateSidebarInfo, 1000);
  </script>
  <!-- <CHANGE> Updated toast notification structure -->
  <div id="toast">
    <div class="toast-icon" id="toastIcon"></div>
    <div class="toast-content">
      <div class="toast-title" id="toastTitle"></div>
      <div class="toast-message" id="toastMessage"></div>
    </div>
  </div>
    <!-- Auth Modal (new, đơn giản) -->
    <div id="authModal" class="hidden" style="position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;">
      <div id="authModalContent" style="background:#1e293b;padding:32px 24px;border-radius:16px;min-width:320px;max-width:90vw;box-shadow:0 8px 32px #000a;position:relative;">
        <span id="closeAuth" style="position:absolute;top:8px;right:16px;font-size:28px;cursor:pointer;color:#fff">&times;</span>
        <h2 style="margin-top:0">Đăng nhập / Đăng ký</h2>
        <form id="authForm">
          <input id="authEmail" type="email" placeholder="Email" required style="width:100%;margin-bottom:10px;padding:10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb" autocomplete="username" />
          <span style="position:relative;display:block;margin-bottom:10px">
            <input id="authPassword" type="password" placeholder="Mật khẩu" required minlength="6" style="width:100%;padding:10px 38px 10px 10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb" autocomplete="current-password" />
            <span id="togglePassword" style="position:absolute;top:50%;right:12px;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#94a3b8;user-select:none;">👁️</span>
          </span>
          <span id="confirmPasswordWrap" style="position:relative;display:none;margin-bottom:10px">
            <input id="authConfirmPassword" type="password" placeholder="Xác nhận mật khẩu" minlength="6" style="width:100%;padding:10px 38px 10px 10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb" autocomplete="new-password" />
            <span id="toggleConfirmPassword" style="position:absolute;top:50%;right:12px;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#94a3b8;user-select:none;">👁️</span>
            <div id="confirmPasswordError" style="color:#ef4444;font-size:13px;margin-top:4px;display:none"></div>
          </span>
          <div style="margin-bottom:10px;display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="rememberMe" style="accent-color:#3b82f6;width:16px;height:16px" />
            <label for="rememberMe" style="color:#e5e7eb;font-size:14px;cursor:pointer;user-select:none">Lưu tài khoản</label>
          </div>
          <button type="submit" class="btn primary" style="width:100%;margin-bottom:8px">Đăng nhập</button>
        </form>
        <button id="googleSignIn" type="button" class="btn" style="width:100%;background:#fff;color:#222;border:1px solid #ccc;margin-bottom:8px"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="height:18px;vertical-align:middle;margin-right:8px">Đăng nhập với Google</button>
        </form>
        <div style="text-align:center;margin-bottom:8px">
          <span id="toggleAuthMode" style="color:#60a5fa;cursor:pointer;font-size:14px">Chưa có tài khoản? Đăng ký</span>
        </div>
        <div id="authError" style="color:#ef4444;text-align:center;font-size:14px;min-height:20px"></div>
      </div>
    </div>
  <button id="openAuth" class="hidden" style="display:none"></button>
  <div class="container">
    <div class="donut-progress-wrap">
      <div class="donut-progress-card">
        <svg id="learnedDonut" width="90" height="90" viewBox="0 0 64 64" style="margin-bottom:10px;">
          <circle cx="32" cy="32" r="26" fill="#181e2a" />
          <circle cx="32" cy="32" r="24" fill="none" stroke="#2e3650" stroke-width="8" />
          <circle id="donutProgress" cx="32" cy="32" r="24" fill="none" stroke="#3b82f6" stroke-width="8" stroke-linecap="round" stroke-dasharray="150.72" stroke-dashoffset="150.72"/>
        </svg>
        <div class="donut-numbers">
          <span class="donut-label">Đã học</span>
          <span id="learnedCount">0</span>
          <span class="donut-sep">/</span>
          <span id="totalWordsCount">0</span>
        </div>
      </div>
    </div>
   




      <nav style="display:flex;justify-content:center;gap:14px;margin-bottom:22px;">
        <button class="tab active" data-tab="lesson">📚 Bài học hôm nay</button>
        <button class="tab" data-tab="practice">🧠 Luyện tập</button>
        <button class="tab" data-tab="learned">✅ Từ đã học</button>
      </nav>
    <!-- LESSON TAB -->
    <section id="tab-lesson">
      <div class="toolbar" style="justify-content:center;gap:20px;background:rgba(255,255,255,0.04);box-shadow:0 2px 8px #0001;border-radius:14px;padding:12px 18px 10px 18px;margin-bottom:18px;">
        <button id="finishDay" class="btn success" style="display:none;min-width:180px;">Đánh dấu hoàn thành ngày học</button>
        <button id="resetToday" class="btn warn" style="min-width:180px;">Chọn lại 5 từ hôm nay</button>
        <span class="muted right" style="font-size:1em;">Mẹo: Bấm vào "Hiện nghĩa" để tự kiểm tra trước khi xem đáp án.</span>
      </div>
  <div id="lesson" class="lesson-grid" style="margin-top:0;grid-gap:28px 18px;"></div>
    </section>

    <!-- PRACTICE TAB -->
    <section id="tab-practice" class="hidden">
      <div class="toolbar">
        <button id="startQuiz" class="btn primary">Bắt đầu bài luyện tập</button>
        <span class="muted">5 câu trắc nghiệm dựa trên 5 từ hôm nay.</span>
      </div>
      <div id="quiz" class="quiz"></div>
    </section>

    <!-- LEARNED TAB -->
    <section id="tab-learned" class="hidden">
      <div class="toolbar">
        <input id="search" type="search" placeholder="Tìm từ hoặc nghĩa đã học..." />
        <button id="exportBtn" class="btn">Tải CSV tất cả từ đã học</button>
        <button id="clearAll" class="btn warn">Xóa TẤT CẢ dữ liệu</button>
      </div>
      <div id="learnedList" class="list"></div>
    </section>

    <div class="footer">Code by Dang Thanh Ha</div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    // Cấu hình Firebase cho web app
    const firebaseConfig = {
      apiKey: "AIzaSyCg9wLWjLkwf5mCaRsAcp3obVi-CKXoH-E",
      authDomain: "learning-english-56f73.firebaseapp.com",
      projectId: "learning-english-56f73",
      storageBucket: "learning-english-56f73.appspot.com",
      messagingSenderId: "339132124762",
      appId: "1:339132124762:web:48a113f910f12fd84a1263",
      measurementId: "G-5FB87HKJGY"
    };
    firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  window.auth = auth;
  const db = firebase.firestore();
    // Firestore helpers
    async function saveLearnedToFirestore(uid, learned) {
      if (!uid) return;
      try {
        await db.collection('users').doc(uid).set({ learned }, { merge: true });
      } catch (e) { console.error('Lỗi lưu Firestore:', e); }
    }
    async function loadLearnedFromFirestore(uid) {
      if (!uid) return null;
      try {
        const doc = await db.collection('users').doc(uid).get();
        return doc.exists && doc.data().learned ? doc.data().learned : [];
      } catch (e) { console.error('Lỗi tải Firestore:', e); return null; }
    }

    // UI logic cho popup đăng nhập/đăng ký
    // Popup đăng nhập/đăng ký, Google sign-in, logout, toast
    (function() {
  // Xử lý ẩn/hiện mật khẩu
  document.getElementById('togglePassword').onclick = function() {
    const pw = document.getElementById('authPassword');
    if (pw.type === 'password') {
      pw.type = 'text';
      this.textContent = '🙈';
    } else {
      pw.type = 'password';
      this.textContent = '👁️';
    }
  };
  // Xử lý ẩn/hiện xác nhận mật khẩu
  document.getElementById('toggleConfirmPassword').onclick = function() {
    const pw = document.getElementById('authConfirmPassword');
    if (pw.type === 'password') {
      pw.type = 'text';
      this.textContent = '🙈';
    } else {
      pw.type = 'password';
      this.textContent = '👁️';
    }
  };
  // Tự động điền email và mật khẩu nếu đã lưu
  const savedAccount = JSON.parse(localStorage.getItem('md5t_saved_account') || 'null');
  if (savedAccount && savedAccount.email && savedAccount.password) {
    document.getElementById('authEmail').value = savedAccount.email;
    document.getElementById('authPassword').value = savedAccount.password;
    document.getElementById('rememberMe').checked = true;
  }
  const authModal = document.getElementById('authModal');
  const authModalContent = document.getElementById('authModalContent');
  const openAuthBtn = document.getElementById('openAuth');
  const logoutBtn = document.getElementById('logoutBtn');
  const closeAuthBtn = document.getElementById('closeAuth');
  const authForm = document.getElementById('authForm');
  const authEmail = document.getElementById('authEmail');
  const authPassword = document.getElementById('authPassword');
  const toggleAuthMode = document.getElementById('toggleAuthMode');
  const authError = document.getElementById('authError');
  const googleSignIn = document.getElementById('googleSignIn');
  const confirmPasswordWrap = document.getElementById('confirmPasswordWrap');
  const authConfirmPassword = document.getElementById('authConfirmPassword');
  const confirmPasswordError = document.getElementById('confirmPasswordError');
  let isSignUp = false;

      function showModal() {
        authModal.style.display = 'flex';
        authModal.classList.remove('hidden');
      }
      function hideModal() {
        authModal.style.display = 'none';
        authModal.classList.add('hidden');
      }
// Toast notification logic (toàn cục)
const toast = document.getElementById('toast');
const toastIcon = document.getElementById('toastIcon');
const toastTitle = document.getElementById('toastTitle');
const toastMessage = document.getElementById('toastMessage');
function showToast(title, message, type = 'info') {
  toastIcon.className = `toast-icon ${type}`;
  switch(type) {
    case 'success': toastIcon.innerHTML = '✓'; break;
    case 'error': toastIcon.innerHTML = '!'; break;
    case 'warning': toastIcon.innerHTML = '⚠'; break;
    default: toastIcon.innerHTML = 'i';
  }
  toastTitle.textContent = title;
  toastMessage.textContent = message;
  toast.classList.add('show');
  setTimeout(() => { toast.classList.remove('show'); }, 8000);
}
window.showToast = showToast;

      if (openAuthBtn) {
        openAuthBtn.onclick = () => {
          showModal();
          authError.textContent = '';
          isSignUp = false;
          if (toggleAuthMode) toggleAuthMode.textContent = 'Chưa có tài khoản? Đăng ký';
          authForm.querySelector('button[type="submit"]').textContent = 'Đăng nhập';
          confirmPasswordWrap.style.display = 'none';
          confirmPasswordError.style.display = 'none';
          authConfirmPassword.value = '';
        };
      }
      if (closeAuthBtn) closeAuthBtn.onclick = hideModal;
      if (authModal) {
        authModal.onclick = function(e) {
          if (e.target === authModal) hideModal();
        };
      }
      if (toggleAuthMode) {
        toggleAuthMode.onclick = () => {
          isSignUp = !isSignUp;
          if(isSignUp) {
            toggleAuthMode.textContent = 'Đã có tài khoản? Đăng nhập';       
            authForm.querySelector('button[type="submit"]').textContent = 'Đăng ký';
            confirmPasswordWrap.style.display = 'block';
          } else {
            toggleAuthMode.textContent = 'Chưa có tài khoản? Đăng ký';
            authForm.querySelector('button[type="submit"]').textContent = 'Đăng nhập';
            confirmPasswordWrap.style.display = 'none';
            confirmPasswordError.style.display = 'none';
            authConfirmPassword.value = '';
          }
          authError.textContent = '';
        };
      }
      authForm.onsubmit = async e => {
        e.preventDefault();
        authError.textContent = '';
        confirmPasswordError.style.display = 'none';
        const email = authEmail.value.trim();
        const pass = authPassword.value;
        const remember = document.getElementById('rememberMe').checked;
        if (isSignUp) {
          // Kiểm tra xác nhận mật khẩu
          if (authConfirmPassword.value !== pass) {
            confirmPasswordError.textContent = 'Mật khẩu xác nhận không khớp.';
            confirmPasswordError.style.display = 'block';
            authConfirmPassword.focus();
            return;
          }
        }
        if (remember) {
          localStorage.setItem('md5t_saved_account', JSON.stringify({ email, password: pass }));
        } else {
          localStorage.removeItem('md5t_saved_account');
        }
        try {
          if(isSignUp) {
            await auth.createUserWithEmailAndPassword(email, pass);
            showToast('Thành công', 'Đăng ký tài khoản thành công!', 'success');
          } else {
            await auth.signInWithEmailAndPassword(email, pass);
            showToast('Thành công', 'Đăng nhập thành công!', 'success');
          }
          hideModal();
        } catch(err) {
          let msg = err.message.replace('Firebase: ', '');
          if (err.code === 'auth/invalid-credential' || msg.includes('auth/invalid-credential')) {
            msg = 'Bạn đã nhập sai tài khoản hoặc mật khẩu.';
          }
          authError.textContent = msg;
          showToast('Lỗi', msg, 'error');
        }
      };
      // Google sign-in
      googleSignIn.onclick = async function() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
          await auth.signInWithPopup(provider);
          showToast('Thành công', 'Đăng nhập Google thành công!', 'success');
          hideModal();
        } catch(err) {
          authError.textContent = err.message.replace('Firebase: ', '');
          showToast('Lỗi', err.message.replace('Firebase: ', ''), 'error');
        }
      };
      // Logout
      // Custom confirm popup
      function showConfirmLogout(onConfirm) {
      let popup = document.getElementById('logoutConfirmPopup');
      if (!popup) {
        popup = document.createElement('div');
        popup.id = 'logoutConfirmPopup';
        popup.innerHTML = `
          <div class="confirm-overlay"></div>
          <div class="confirm-box">
            <div class="confirm-title">Xác nhận đăng xuất</div>
            <div class="confirm-msg">Bạn có chắc chắn muốn đăng xuất không?</div>
            <div class="confirm-actions">
              <button id="confirmLogoutBtn" class="btn primary">Đồng ý</button>
              <button id="cancelLogoutBtn" class="btn warn">Hủy</button>
            </div>
          </div>
        `;
        document.body.appendChild(popup);
      }
      popup.style.display = 'block';
      popup.querySelector('#confirmLogoutBtn').onclick = () => {
        popup.style.display = 'none';
        onConfirm();
      };
      popup.querySelector('#cancelLogoutBtn').onclick = () => {
        popup.style.display = 'none';
      };
    }

// Ensure global access for sidebar logout
window.showConfirmLogout = showConfirmLogout;

      if (logoutBtn) {
        logoutBtn.onclick = async function() {
          showConfirmLogout(async () => {
            await auth.signOut();
            showToast('Đăng xuất thành công!', 'success');
          });
        };
      }
      // Hiển thị nút đăng nhập/đăng xuất phù hợp
      // Khi trạng thái đăng nhập thay đổi, load dữ liệu Firestore nếu có
      if (typeof auth !== 'undefined' && auth && typeof auth.onAuthStateChanged === 'function') {
        auth.onAuthStateChanged(async user => {
          const userInfo = document.getElementById('userInfo');
          const openAuthBtn = document.getElementById('openAuth');
          const logoutBtn = document.getElementById('logoutBtn');
          if(user) {
            if (openAuthBtn) openAuthBtn.style.display = 'none';
            if (logoutBtn) logoutBtn.style.display = 'inline-block';
            if (userInfo) {
              userInfo.style.display = 'inline-block';
              userInfo.textContent = user.email ? `👤 ${user.email}` : '';
            }
            // Load "learned" từ Firestore
            const learned = await loadLearnedFromFirestore(user.uid);
            if (learned) {
              localStorage.setItem(LS_KEYS.learned, JSON.stringify(learned));
              renderLearned();
            }
          } else {
            if (openAuthBtn) openAuthBtn.style.display = 'inline-block';
            if (logoutBtn) logoutBtn.style.display = 'none';
            if (userInfo) userInfo.style.display = 'none';
          }
          // Luôn cập nhật lại thông tin sidebar khi trạng thái đăng nhập thay đổi
          if (typeof updateSidebarInfo === 'function') updateSidebarInfo();
        });
      }
    })();
    /******************** Data ********************/
    // Load corpus từ file ngoài (corpus.json)
    let CORPUS = [];
  async function loadCorpus() {
      try {
        let res = await fetch('corpus_translated.json');
        if (!res.ok) throw new Error('Không tải được corpus_translated.json');
        CORPUS = await res.json();
        if (!Array.isArray(CORPUS) || CORPUS.length < 10) throw new Error('corpus_translated.json rỗng hoặc lỗi');
      } catch (e1) {
        try {
          let res2 = await fetch('corpus.json');
          if (!res2.ok) throw new Error('Không tải được corpus.json');
          CORPUS = await res2.json();
          if (!Array.isArray(CORPUS) || CORPUS.length < 10) throw new Error('corpus.json rỗng hoặc lỗi');
        } catch (e2) {
          // fallback: dữ liệu mẫu nếu không tải được file ngoài
          CORPUS = [
            {w:'abandon', p:'/əˈbændən/', v:'từ bỏ; bỏ rơi', h:'They had to abandon the car.', h_vi:'Họ đã phải bỏ chiếc xe.'},
            {w:'ability', p:'/əˈbɪləti/', v:'khả năng', h:'Her ability is impressive.', h_vi:'Khả năng của cô ấy thật ấn tượng.'}
          ];
          console.error('Lỗi tải corpus:', e1, e2);
        }
      }
      window.CORPUS = CORPUS;
    }

    const LS_KEYS = {
      todaySet: 'md5t_today_set',        // {date:'YYYY-MM-DD', items:[indexes]}
      learned: 'md5t_learned',           // [{date, items:[{w,p,v}]}]
      usedIndex: 'md5t_used_indexes',    // number[] to avoid repeat
      streak: 'md5t_streak',
      lastDate: 'md5t_last_date'
    };

    /******************** Utilities ********************/
    // Lấy ngày theo múi giờ Việt Nam (GMT+7)
    function fmtDateVN(d = new Date()) {
      // Chuyển sang giờ Việt Nam
      const tzOffset = 7 * 60; // phút
      const local = new Date(d.getTime() + (tzOffset - d.getTimezoneOffset()) * 60000);
      // yyyy-mm-dd
      return local.toISOString().slice(0, 10);
    }
    const today = fmtDateVN();
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function load(key, fallback){
      try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch{ return fallback }
    }
    function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] }
      return arr;
    }

    /******************** Today set logic ********************/
    function ensureTodaySet(){
      let todaySet = load(LS_KEYS.todaySet, null);
      if(!todaySet || todaySet.date !== today){
        // pick 5 new indices not used yet
        const used = new Set(load(LS_KEYS.usedIndex, []));
        const available = CORPUS.map((_,i)=>i).filter(i=>!used.has(i));
        let picks = [];
        if(available.length >= 5){
          shuffle(available); picks = available.slice(0,5);
        }else{
          // not enough fresh words: include remaining + random from start
          const rest = available.slice();
          const need = 5 - rest.length;
          const pool = CORPUS.map((_,i)=>i);
          shuffle(pool);
          picks = rest.concat(pool.slice(0,need));
        }
        todaySet = {date: today, items: picks};
        save(LS_KEYS.todaySet, todaySet);
      }
      return todaySet;
    }

    function markUsed(indexes){
      const used = new Set(load(LS_KEYS.usedIndex, []));
      indexes.forEach(i=>used.add(i));
      save(LS_KEYS.usedIndex, Array.from(used));
    }

    function updateStreak(){
      const last = load(LS_KEYS.lastDate, null);
      let s = load(LS_KEYS.streak, 0);
      if(last){
        const diff = (new Date(today) - new Date(last))/(1000*3600*24);
        if(diff === 1){ s += 1; }
        else if(diff > 1){ s = 1; }
      }else{ s = 1; }
      save(LS_KEYS.streak, s); save(LS_KEYS.lastDate, today); return s;
    }

    /******************** Render Lesson ********************/
    function renderLesson(){
      const set = ensureTodaySet();
      // Hiển thị ngày theo định dạng dd/mm/yyyy
      const [y, m, d] = set.date.split('-');
      $('#todayLabel').textContent = 'Hôm nay: ' + `${d}/${m}/${y}`;
      const totalWordsEl = document.getElementById('totalWords');
      if (totalWordsEl) totalWordsEl.textContent = CORPUS.length;

      const frag = document.createDocumentFragment();
      set.items.forEach((idx, order)=>{
        const it = CORPUS[idx];
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${order+1}. ${it.w}</h3>
          <div class="phonetic">${it.p || ''}</div>
          <div class="meaning"><span class="vi hidden">${it.v}</span>
            <button class="btn reveal">Hiện nghĩa</button>
          </div>
          <div class="muted" style="margin-top:8px">Ví dụ: <em>${it.h || ''}</em>
            ${it.h_vi ? `<button class='btn btn-xs reveal-example' style='margin-left:10px'>Hiện nghĩa ví dụ</button> <span class='example-vi hidden' style='color:#16a34a'>${it.h_vi}</span>` : ''}
          </div>
        `;
        frag.appendChild(card);
      });
      const root = $('#lesson'); root.innerHTML=''; root.appendChild(frag);
      $$('#lesson .reveal').forEach(btn=>btn.addEventListener('click', e=>{
        const box = e.currentTarget.closest('.meaning');
        box.querySelector('.vi').classList.remove('hidden');
        e.currentTarget.remove();
      }));
      $$('#lesson .reveal-example').forEach(btn=>btn.addEventListener('click', e=>{
        const box = e.currentTarget.closest('.muted');
        box.querySelector('.example-vi').classList.remove('hidden');
        e.currentTarget.remove();
      }));

  // progress
  const learned = load(LS_KEYS.learned, []);
  const learnedCount = learned.reduce((acc,g)=>acc+g.items.length,0);
  const progressEl = document.getElementById('progress');
  if (progressEl) progressEl.textContent = learnedCount;
  const streakEl = document.getElementById('streak');
  if (streakEl) streakEl.textContent = load(LS_KEYS.streak, 0);
    }

    /******************** Finish Day ********************/
    async function finishDay(){
      const set = ensureTodaySet();
      const items = set.items.map(i=>({w:CORPUS[i].w, p:CORPUS[i].p, v:CORPUS[i].v}));
      let learned = load(LS_KEYS.learned, []);
      if(!learned.find(g=>g.date===set.date)){
        learned.push({date:set.date, items});
        save(LS_KEYS.learned, learned);
        markUsed(set.items);
        updateStreak();
        // Nếu đã đăng nhập thì lưu lên Firestore
        if(auth.currentUser) await saveLearnedToFirestore(auth.currentUser.uid, learned);
        // <CHANGE> Updated to use new toast system
  showToast('Hoàn thành!', `Đã lưu 5 từ của ngày ${set.date} vào danh sách đã học.`, 'success');
      } else {
        // <CHANGE> Updated to use new toast system
  showToast('Thông báo', 'Ngày hôm nay đã được lưu trước đó.', 'warning');
      }
      renderLesson(); renderLearned();
    }

    /******************** Learned List ********************/
    function renderLearned(){
      const learned = load(LS_KEYS.learned, []);
      const list = $('#learnedList'); list.innerHTML='';
      learned.sort((a,b)=> b.date.localeCompare(a.date));
      learned.forEach(group=>{
        const wrap = document.createElement('details');
        wrap.open = false;
        const tags = group.items.map(it=>`<span class="tag">${it.w} <span style="opacity:.6">(${it.v})</span></span>`).join('');
        wrap.innerHTML = `<summary>${group.date} — ${group.items.length} từ</summary><div style="margin-top:8px">${tags}</div>`;
        list.appendChild(wrap);
      });
    }

    // Search filter
    $('#search').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      $$('#learnedList details').forEach(d=>{
        if(!q){ d.classList.remove('hidden'); return; }
        const text = d.textContent.toLowerCase();
        d.classList.toggle('hidden', !text.includes(q));
      });
    });

    // Export CSV
    function exportCSV(){
      const learned = load(LS_KEYS.learned, []);
      const rows = [['date','word','phonetic','vi']];
      learned.forEach(g=>g.items.forEach(it=>rows.push([g.date,it.w,it.p||'',it.v])));
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='md5t_learned.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    /******************** Quiz ********************/
    function startQuiz(){
      const set = ensureTodaySet();
      const todayWords = set.items.map(i=>CORPUS[i]);
      if(todayWords.length < 5){ 
        // <CHANGE> Updated to use new toast system
        showToast('Lỗi', 'Chưa có đủ từ cho hôm nay.', 'error'); 
        return; 
      }
      const questions = todayWords.map(it=>({
        prompt:`Từ nào khớp với nghĩa: \"${it.v}\"?`,
        correct: it.w,
        options: shuffle([it.w, ...shuffle(CORPUS.filter(x=>x.w!==it.w)).slice(0,3).map(x=>x.w)])
      }));
      renderQuiz(questions);
    }

    function renderQuiz(questions){
      const quizRoot = $('#quiz'); quizRoot.innerHTML='';
      let score = 0, answered = 0;

      questions.forEach((q, qi)=>{
        const card = document.createElement('div'); card.className='q-card';
        card.innerHTML = `<div><strong>Câu ${qi+1}</strong>: ${q.prompt}</div>`;
        const choices = document.createElement('div'); choices.className='choices';
        q.options.forEach(opt=>{
          const btn = document.createElement('button'); btn.className='choice'; btn.textContent=opt;
          btn.addEventListener('click',()=>{
            if(btn.classList.contains('correct') || btn.classList.contains('wrong')) return;
            answered++;
            if(opt===q.correct){
              btn.classList.add('correct');
              score++;
              try { correctSound.currentTime = 0; correctSound.play(); } catch(e){}
            }
            else {
              btn.classList.add('wrong');
              try { wrongSound.currentTime = 0; wrongSound.play(); } catch(e){}
              [...choices.children].forEach(c=>{ if(c.textContent===q.correct) c.classList.add('correct'); });
            }
            if(answered===questions.length){
              const res = document.createElement('div'); res.style.marginTop='14px';
              res.innerHTML = `<div class=\"card\">✅ Hoàn thành! Điểm: <strong>${score}/${questions.length}</strong> — ${(score*100/questions.length).toFixed(0)}%</div>`;
              quizRoot.appendChild(res);
              if(score === questions.length) {
                document.getElementById('finishDay').style.display = 'inline-block';
              } else {
                document.getElementById('finishDay').style.display = 'none';
                // Hiện popup thông báo và nút làm lại
                showQuizRetryPopup();
              }
            }
// Popup khi không đủ 5/5 điểm quiz
function showQuizRetryPopup() {
  let popup = document.getElementById('quizRetryPopup');
  if (!popup) {
    popup = document.createElement('div');
    popup.id = 'quizRetryPopup';
    popup.innerHTML = `
      <div style="position:fixed;z-index:3000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;">
        <div style="background:#fff;color:#222;border-radius:16px;min-width:320px;box-shadow:0 8px 32px #0005;padding:32px 28px 22px 28px;text-align:center;animation:popupIn .25s;max-width:90vw;">
          <div style="font-size:20px;font-weight:600;margin-bottom:10px;">Hãy làm đúng 5/5 để đánh dấu hoàn thành ngày học</div>
          <button id="quizRetryBtn" class="btn primary" style="margin-top:18px;min-width:120px;">Làm lại</button>
        </div>
      </div>
    `;
    document.body.appendChild(popup);
  }
  popup.style.display = 'flex';
  const btn = popup.querySelector('#quizRetryBtn');
  if(btn) {
    btn.onclick = function() {
      popup.style.display = 'none';
      // Gọi lại startQuiz để làm lại quiz
      if(typeof startQuiz === 'function') startQuiz();
    };
  }
}
          });
          choices.appendChild(btn);
        });
        card.appendChild(choices); quizRoot.appendChild(card);
      });
    }

    /******************** Tabs & Actions ********************/
    function switchTab(name){
      $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
      ['lesson','practice','learned'].forEach(id=>{
        $('#tab-'+id).classList.toggle('hidden', id!==name);
      });
    }

    $$('.tab').forEach(btn=>btn.addEventListener('click',()=>switchTab(btn.dataset.tab)));
    $('#finishDay').addEventListener('click', async function() {
      // Kiểm tra lại điểm số cuối cùng
      const quizCard = document.querySelector('#quiz .card');
      if(quizCard && quizCard.textContent.includes('Điểm:')) {
        const match = quizCard.textContent.match(/Điểm: (\d+)\/(\d+)/);
        if(match && match[1] !== match[2]) {
          showToast('Bạn phải hoàn thành đúng 5/5 thì mới được đánh dấu hoàn thành ngày học', 'error');
         
          return;
        }
      }
  await finishDay();
  showToast('Đánh dấu hoàn thành ngày học thành công!', '', 'success');
  setTimeout(()=>{ location.reload(); }, 1500);
    });
    $('#resetToday').addEventListener('click', ()=>{
      if(confirm('Chọn lại 5 từ hôm nay? (Không ảnh hưởng đến các ngày đã lưu)')){
        localStorage.removeItem(LS_KEYS.todaySet);
        renderLesson(); // regenerate
        // <CHANGE> Added toast notification for reset
        showToast('Đã reset', 'Đã chọn lại 5 từ mới cho hôm nay.', 'info');
      }
    });
    $('#exportBtn').addEventListener('click', exportCSV);
    $('#clearAll').addEventListener('click', ()=>{
      if(confirm('XÓA TẤT CẢ dữ liệu (bài học, tiến độ, streak)?')){
        Object.values(LS_KEYS).forEach(k=>localStorage.removeItem(k));
        // Reset stepper UI về trạng thái ban đầu (xóa class active, done)
        const stepper = document.getElementById('learningStepper');
        if (stepper) {
          stepper.querySelectorAll('.step').forEach(step => step.classList.remove('active','done'));
        }
        // Nếu đã đăng nhập thì xóa trường 'learned' trong Firestore, chờ thao tác xong mới reload
        const reloadPage = ()=>{
          showToast('Đã xóa tất cả dữ liệu!', '', 'success');
          setTimeout(()=>{ location.reload(); }, 1500);
        };
        if(typeof auth !== 'undefined' && auth.currentUser && typeof firebase !== 'undefined'){
          db.collection('users').doc(auth.currentUser.uid)
            .update({ learned: firebase.firestore.FieldValue.delete() })
            .then(reloadPage)
            .catch(reloadPage);
        } else {
          reloadPage();
        }
      }
    });
    $('#startQuiz').addEventListener('click', startQuiz);

    /******************** Init ********************/
    async function init(){
      await loadCorpus();
      renderLesson();
      renderLearned();
      if (typeof updateSidebarInfo === 'function') updateSidebarInfo();
    }
    init();
  </script>
</body>
</html>
