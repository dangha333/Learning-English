<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mỗi ngày 5 từ tiếng Anh mới</title>
  <style>
    :root{
      --bg:#0f172a;      /* slate-900 */
      --card:#111827ee;  /* gray-900 */
      --text:#e5e7eb;    /* gray-200 */
      --muted:#94a3b8;   /* slate-400 */
      --accent:#22c55e;  /* green-500 */
      --primary:#60a5fa; /* blue-400 */
      --danger:#ef4444;  /* red-500 */
      --warning:#f59e0b; /* amber-500 */
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, #1f2937, transparent),
                  radial-gradient(1200px 800px at 110% 10%, #0b3b70, transparent),
                  var(--bg);
      min-height:100vh; overflow-x:hidden;
    }
    header{
      padding:24px 16px; position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);
      background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.6));
      border-bottom:1px solid #1f2937;
    }
    .container{max-width:1000px; margin:0 auto; padding:0 12px}
    h1{margin:0; font-size:clamp(20px,3.4vw,36px); letter-spacing:.2px}
    .sub{color:var(--muted); font-size:14px}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:8px}
    .pill{padding:6px 10px; border:1px solid #374151; border-radius:999px; color:var(--muted); font-size:12px}
    nav{display:flex; gap:8px; margin-top:14px}
    .tab{border:1px solid #334155; background:#0b1220; color:#cbd5e1; padding:10px 14px; border-radius:10px; cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#0a1a34,#0b1220); border-color:#3b82f6; color:white; box-shadow:0 0 0 2px #1d4ed8 inset}
    main{padding:24px 0 48px}

    .lesson-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:14px}
    .card{background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h3{margin:0 0 6px; font-size:22px}
    .phonetic{color:#a5b4fc}
    .meaning{margin-top:10px; padding:10px; border-radius:12px; background:#0b1220; border:1px dashed #334155; color:#e2e8f0; display:flex; justify-content:space-between; align-items:center}
    .meaning button{margin-left:10px}

    .btn{appearance:none; border:1px solid #334155; color:#e5e7eb; background:#0b1220; padding:10px 12px; border-radius:12px; cursor:pointer}
    .btn:hover{border-color:#475569}
    .btn.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8); border:none}
    .btn.success{background:linear-gradient(180deg,#22c55e,#16a34a); border:none}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706); border:none}
    .btn.ghost{background:transparent}

    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:14px 0}
    .muted{color:var(--muted)}

    .list{display:grid; gap:10px}
    details{background:var(--card); border:1px solid #1f2937; border-radius:14px; padding:10px 12px}
    summary{cursor:pointer; font-weight:600}
    .tag{display:inline-block; margin:6px 6px 0 0; padding:6px 10px; background:#0b1220; border:1px solid #334155; border-radius:999px; font-size:12px}

    .quiz{max-width:700px}
    .q-card{background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px}
    .choices{display:grid; gap:10px; margin-top:10px}
    .choice{padding:10px 12px; border:1px solid #334155; border-radius:12px; cursor:pointer; background:#0b1220}
    .choice.correct{border-color:var(--accent)}
    .choice.wrong{border-color:var(--danger)}

    .footer{margin-top:28px; color:var(--muted); font-size:12px; text-align:center}
    .right{margin-left:auto}
    .hidden{display:none}
    input[type="search"]{background:#0b1220; border:1px solid #334155; color:#e5e7eb; border-radius:10px; padding:10px; min-width:220px}
  </style>
</head>
<body>
  <header>
  <!-- Toast notification -->
  <div id="toast" style="position:fixed;top:24px;right:24px;z-index:2000;min-width:180px;max-width:90vw;padding:14px 24px;background:#222;border-radius:8px;color:#fff;font-size:16px;box-shadow:0 4px 24px #0007;display:none;align-items:center;gap:8px"></div>
    <!-- Auth Modal (new, đơn giản) -->
    <div id="authModal" class="hidden" style="position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;">
      <div id="authModalContent" style="background:#1e293b;padding:32px 24px;border-radius:16px;min-width:320px;max-width:90vw;box-shadow:0 8px 32px #000a;position:relative;">
        <span id="closeAuth" style="position:absolute;top:8px;right:16px;font-size:28px;cursor:pointer;color:#fff">&times;</span>
        <h2 style="margin-top:0">Đăng nhập / Đăng ký</h2>
        <form id="authForm">
          <input id="authEmail" type="email" placeholder="Email" required style="width:100%;margin-bottom:10px;padding:10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb" />
          <input id="authPassword" type="password" placeholder="Mật khẩu" required minlength="6" style="width:100%;margin-bottom:10px;padding:10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb" />
          <button type="submit" class="btn primary" style="width:100%;margin-bottom:8px">Đăng nhập</button>
  </form>
  <button id="googleSignIn" type="button" class="btn" style="width:100%;background:#fff;color:#222;border:1px solid #ccc;margin-bottom:8px"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="height:18px;vertical-align:middle;margin-right:8px">Đăng nhập với Google</button>
        </form>
        <div style="text-align:center;margin-bottom:8px">
          <span id="toggleAuthMode" style="color:#60a5fa;cursor:pointer;font-size:14px">Chưa có tài khoản? Đăng ký</span>
        </div>
        <div id="authError" style="color:#ef4444;text-align:center;font-size:14px;min-height:20px"></div>
      </div>
    </div>
    <div class="container">
      <h1>Mỗi ngày 5 từ tiếng Anh mới</h1>
      <div class="row">
        <div class="pill" id="todayLabel">Hôm nay: —</div>
        <div class="pill">Tiến độ: <span id="progress">0</span> / <span id="totalWords">0</span> từ</div>
        <div class="pill">Ngày liên tiếp: <span id="streak">0</span> 🔥</div>
      </div>


        <nav>
          <button class="tab active" data-tab="lesson">📚 Bài học hôm nay</button>
          <button class="tab" data-tab="practice">🧠 Luyện tập</button>
          <button class="tab" data-tab="learned">✅ Từ đã học</button>
          <button id="openAuth" class="btn ghost right" style="margin-left:auto">Đăng nhập</button>
          <button id="logoutBtn" class="btn warn right" style="margin-left:8px;display:none">Đăng xuất</button>
        </nav>
    <!-- LESSON TAB -->
    <section id="tab-lesson">
      <div class="toolbar">
        <button id="finishDay" class="btn success">Đánh dấu hoàn thành ngày học</button>
        <button id="resetToday" class="btn warn">Chọn lại 5 từ hôm nay</button>
        <span class="muted right">Mẹo: Bấm vào "Hiện nghĩa" để tự kiểm tra trước khi xem đáp án.</span>
      </div>
      <div id="lesson" class="lesson-grid"></div>
    </section>

    <!-- PRACTICE TAB -->
    <section id="tab-practice" class="hidden">
      <div class="toolbar">
        <button id="startQuiz" class="btn primary">Bắt đầu bài luyện tập</button>
        <span class="muted">5 câu trắc nghiệm dựa trên 5 từ hôm nay.</span>
      </div>
      <div id="quiz" class="quiz"></div>
    </section>

    <!-- LEARNED TAB -->
    <section id="tab-learned" class="hidden">
      <div class="toolbar">
        <input id="search" type="search" placeholder="Tìm từ hoặc nghĩa đã học..." />
        <button id="exportBtn" class="btn">Tải CSV tất cả từ đã học</button>
        <button id="clearAll" class="btn warn">Xóa TẤT CẢ dữ liệu</button>
      </div>
      <div id="learnedList" class="list"></div>
    </section>

    <div class="footer">Dữ liệu lưu trên trình duyệt (localStorage). Từ vựng mẫu có sẵn, bạn có thể mở rộng trong mã nguồn.</div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script>
    // Cấu hình Firebase cho web app
    const firebaseConfig = {
      apiKey: "AIzaSyCg9wLWjLkwf5mCaRsAcp3obVi-CKXoH-E",
      authDomain: "learning-english-56f73.firebaseapp.com",
      projectId: "learning-english-56f73",
      storageBucket: "learning-english-56f73.appspot.com",
      messagingSenderId: "339132124762",
      appId: "1:339132124762:web:48a113f910f12fd84a1263",
      measurementId: "G-5FB87HKJGY"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    // UI logic cho popup đăng nhập/đăng ký
    // Popup đăng nhập/đăng ký, Google sign-in, logout, toast
    (function() {
      const authModal = document.getElementById('authModal');
      const authModalContent = document.getElementById('authModalContent');
      const openAuthBtn = document.getElementById('openAuth');
      const logoutBtn = document.getElementById('logoutBtn');
      const closeAuthBtn = document.getElementById('closeAuth');
      const authForm = document.getElementById('authForm');
      const authEmail = document.getElementById('authEmail');
      const authPassword = document.getElementById('authPassword');
      const toggleAuthMode = document.getElementById('toggleAuthMode');
      const authError = document.getElementById('authError');
      const googleSignIn = document.getElementById('googleSignIn');
      const toast = document.getElementById('toast');
      let isSignUp = false;

      function showModal() {
        authModal.style.display = 'flex';
        authModal.classList.remove('hidden');
      }
      function hideModal() {
        authModal.style.display = 'none';
        authModal.classList.add('hidden');
      }
      function showToast(msg, color) {
        toast.textContent = msg;
        toast.style.display = 'flex';
        toast.style.background = color || '#222';
        setTimeout(()=>{ toast.style.display = 'none'; }, 2200);
      }
      openAuthBtn.onclick = () => {
        showModal();
        authError.textContent = '';
        isSignUp = false;
        toggleAuthMode.textContent = 'Chưa có tài khoản? Đăng ký';
        authForm.querySelector('button[type="submit"]').textContent = 'Đăng nhập';
      };
      closeAuthBtn.onclick = hideModal;
      authModal.onclick = function(e) {
        if (e.target === authModal) hideModal();
      };
      toggleAuthMode.onclick = () => {
        isSignUp = !isSignUp;
        if(isSignUp) {
          toggleAuthMode.textContent = 'Đã có tài khoản? Đăng nhập';
          authForm.querySelector('button[type="submit"]').textContent = 'Đăng ký';
        } else {
          toggleAuthMode.textContent = 'Chưa có tài khoản? Đăng ký';
          authForm.querySelector('button[type="submit"]').textContent = 'Đăng nhập';
        }
        authError.textContent = '';
      };
      authForm.onsubmit = async e => {
        e.preventDefault();
        authError.textContent = '';
        const email = authEmail.value.trim();
        const pass = authPassword.value;
        try {
          if(isSignUp) {
            await auth.createUserWithEmailAndPassword(email, pass);
            showToast('Đăng ký thành công!', '#22c55e');
          } else {
            await auth.signInWithEmailAndPassword(email, pass);
            showToast('Đăng nhập thành công!', '#22c55e');
          }
          hideModal();
        } catch(err) {
          authError.textContent = err.message.replace('Firebase: ', '');
        }
      };
      // Google sign-in
      googleSignIn.onclick = async function() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
          await auth.signInWithPopup(provider);
          showToast('Đăng nhập Google thành công!', '#22c55e');
          hideModal();
        } catch(err) {
          authError.textContent = err.message.replace('Firebase: ', '');
        }
      };
      // Logout
      logoutBtn.onclick = async function() {
        await auth.signOut();
        showToast('Đăng xuất thành công!', '#60a5fa');
      };
      // Hiển thị nút đăng nhập/đăng xuất phù hợp
      auth.onAuthStateChanged(user => {
        if(user) {
          openAuthBtn.style.display = 'none';
          logoutBtn.style.display = 'inline-block';
        } else {
          openAuthBtn.style.display = 'inline-block';
          logoutBtn.style.display = 'none';
        }
      });
    })();
    /******************** Data ********************/
    // Kho từ mẫu: {word, phonetic, vi, hint}
    const CORPUS = [
      {w:'abandon', p:'/əˈbændən/', v:'từ bỏ; bỏ rơi', h:'They had to abandon the car.'},
      {w:'ability', p:'/əˈbɪləti/', v:'khả năng', h:'Her ability is impressive.'},
      {w:'accurate', p:'/ˈækjərət/', v:'chính xác', h:'An accurate report.'},
      {w:'achieve', p:'/əˈtʃiːv/', v:'đạt được', h:'Achieve your goals.'},
      {w:'active', p:'/ˈæktɪv/', v:'năng động; tích cực', h:'An active lifestyle.'},
      {w:'adapt', p:'/əˈdæpt/', v:'thích nghi', h:'Adapt to changes.'},
      {w:'advantage', p:'/ədˈvɑːntɪdʒ/', v:'lợi thế', h:'Have an advantage.'},
      {w:'afford', p:'/əˈfɔːd/', v:'có đủ khả năng (chi trả)', h:'Can you afford it?'},
      {w:'ambition', p:'/æmˈbɪʃn/', v:'tham vọng', h:'Great ambition.'},
      {w:'ancient', p:'/ˈeɪnʃənt/', v:'cổ xưa', h:'Ancient city.'},
      {w:'approve', p:'/əˈpruːv/', v:'tán thành; phê duyệt', h:'Approve a plan.'},
      {w:'assist', p:'/əˈsɪst/', v:'hỗ trợ', h:'Assist a customer.'},
      {w:'attempt', p:'/əˈtempt/', v:'cố gắng; thử', h:'Attempt to fix it.'},
      {w:'attract', p:'/əˈtrækt/', v:'thu hút', h:'Attract attention.'},
      {w:'balance', p:'/ˈbæləns/', v:'cân bằng', h:'Work-life balance.'},
      {w:'behave', p:'/bɪˈheɪv/', v:'cư xử', h:'Behave well.'},
      {w:'benefit', p:'/ˈbenɪfɪt/', v:'lợi ích; có lợi', h:'Mutual benefit.'},
      {w:'borrow', p:'/ˈbɒrəʊ/', v:'mượn', h:'Borrow a book.'},
      {w:'brief', p:'/briːf/', v:'ngắn gọn', h:'A brief meeting.'},
      {w:'capable', p:'/ˈkeɪpəbl/', v:'có khả năng', h:'Capable team.'},
      {w:'careful', p:'/ˈkeəfl/', v:'cẩn thận', h:'Be careful.'},
      {w:'challenge', p:'/ˈtʃælɪndʒ/', v:'thử thách', h:'Face a challenge.'},
      {w:'change', p:'/tʃeɪndʒ/', v:'thay đổi', h:'Change your mind.'},
      {w:'clarify', p:'/ˈklærɪfaɪ/', v:'làm rõ', h:'Clarify a point.'},
      {w:'combine', p:'/kəmˈbaɪn/', v:'kết hợp', h:'Combine ideas.'},
      {w:'commit', p:'/kəˈmɪt/', v:'cam kết; phạm', h:'Commit to learning.'},
      {w:'compare', p:'/kəmˈpeə(r)/', v:'so sánh', h:'Compare prices.'},
      {w:'complete', p:'/kəmˈpliːt/', v:'hoàn thành', h:'Complete a task.'},
      {w:'confident', p:'/ˈkɒnfɪdənt/', v:'tự tin', h:'Feel confident.'},
      {w:'consider', p:'/kənˈsɪdə(r)/', v:'cân nhắc; xem xét', h:'Consider options.'},
      {w:'create', p:'/kriˈeɪt/', v:'tạo ra', h:'Create content.'},
      {w:'curious', p:'/ˈkjʊəriəs/', v:'tò mò', h:'A curious child.'},
      {w:'decrease', p:'/dɪˈkriːs/', v:'giảm', h:'Decrease costs.'},
      {w:'deliver', p:'/dɪˈlɪvə(r)/', v:'giao; trình bày', h:'Deliver a speech.'},
      {w:'depend', p:'/dɪˈpend/', v:'phụ thuộc', h:'Depend on you.'},
      {w:'design', p:'/dɪˈzaɪn/', v:'thiết kế', h:'Design a logo.'},
      {w:'develop', p:'/dɪˈveləp/', v:'phát triển', h:'Develop skills.'},
      {w:'education', p:'/ˌedʒuˈkeɪʃn/', v:'giáo dục', h:'Education matters.'},
      {w:'effort', p:'/ˈefət/', v:'nỗ lực', h:'Make an effort.'},
      {w:'efficient', p:'/ɪˈfɪʃnt/', v:'hiệu quả', h:'Efficient system.'},
      {w:'encourage', p:'/ɪnˈkʌrɪdʒ/', v:'khuyến khích', h:'Encourage learning.'},
      {w:'energy', p:'/ˈenədʒi/', v:'năng lượng', h:'Save energy.'},
      {w:'engineer', p:'/ˌendʒɪˈnɪə(r)/', v:'kỹ sư', h:'Software engineer.'},
      {w:'enjoy', p:'/ɪnˈdʒɔɪ/', v:'thưởng thức; thích', h:'Enjoy the show.'},
      {w:'environment', p:'/ɪnˈvaɪrənmənt/', v:'môi trường', h:'Protect the environment.'},
      {w:'evidence', p:'/ˈevɪdəns/', v:'bằng chứng', h:'Strong evidence.'},
      {w:'expand', p:'/ɪkˈspænd/', v:'mở rộng', h:'Expand the team.'},
      {w:'experience', p:'/ɪkˈspɪəriəns/', v:'kinh nghiệm; trải nghiệm', h:'Work experience.'},
      {w:'explain', p:'/ɪkˈspleɪn/', v:'giải thích', h:'Explain clearly.'},
      {w:'feature', p:'/ˈfiːtʃə(r)/', v:'tính năng; đặc điểm', h:'New feature.'},
      {w:'focus', p:'/ˈfəʊkəs/', v:'tập trung', h:'Focus on tasks.'},
      {w:'frequent', p:'/ˈfriːkwənt/', v:'thường xuyên', h:'Frequent visits.'}
    ];

    const LS_KEYS = {
      todaySet: 'md5t_today_set',        // {date:'YYYY-MM-DD', items:[indexes]}
      learned: 'md5t_learned',           // [{date, items:[{w,p,v}]}]
      usedIndex: 'md5t_used_indexes',    // number[] to avoid repeat
      streak: 'md5t_streak',
      lastDate: 'md5t_last_date'
    };

    /******************** Utilities ********************/
    const fmtDate = (d=new Date()) => d.toISOString().slice(0,10);
    const today = fmtDate();
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function load(key, fallback){
      try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch{ return fallback }
    }
    function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] }
      return arr;
    }

    /******************** Today set logic ********************/
    function ensureTodaySet(){
      let todaySet = load(LS_KEYS.todaySet, null);
      if(!todaySet || todaySet.date !== today){
        // pick 5 new indices not used yet
        const used = new Set(load(LS_KEYS.usedIndex, []));
        const available = CORPUS.map((_,i)=>i).filter(i=>!used.has(i));
        let picks = [];
        if(available.length >= 5){
          shuffle(available); picks = available.slice(0,5);
        }else{
          // not enough fresh words: include remaining + random from start
          const rest = available.slice();
          const need = 5 - rest.length;
          const pool = CORPUS.map((_,i)=>i);
          shuffle(pool);
          picks = rest.concat(pool.slice(0,need));
        }
        todaySet = {date: today, items: picks};
        save(LS_KEYS.todaySet, todaySet);
      }
      return todaySet;
    }

    function markUsed(indexes){
      const used = new Set(load(LS_KEYS.usedIndex, []));
      indexes.forEach(i=>used.add(i));
      save(LS_KEYS.usedIndex, Array.from(used));
    }

    function updateStreak(){
      const last = load(LS_KEYS.lastDate, null);
      let s = load(LS_KEYS.streak, 0);
      if(last){
        const diff = (new Date(today) - new Date(last))/(1000*3600*24);
        if(diff === 1){ s += 1; }
        else if(diff > 1){ s = 1; }
      }else{ s = 1; }
      save(LS_KEYS.streak, s); save(LS_KEYS.lastDate, today); return s;
    }

    /******************** Render Lesson ********************/
    function renderLesson(){
      const set = ensureTodaySet();
      $('#todayLabel').textContent = 'Hôm nay: ' + set.date;
      $('#totalWords').textContent = CORPUS.length;

      const frag = document.createDocumentFragment();
      set.items.forEach((idx, order)=>{
        const it = CORPUS[idx];
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${order+1}. ${it.w}</h3>
          <div class="phonetic">${it.p || ''}</div>
          <div class="meaning"><span class="vi hidden">${it.v}</span>
            <button class="btn reveal">Hiện nghĩa</button>
          </div>
          <div class="muted" style="margin-top:8px">Ví dụ: <em>${it.h || ''}</em></div>
        `;
        frag.appendChild(card);
      });
      const root = $('#lesson'); root.innerHTML=''; root.appendChild(frag);
      $$('#lesson .reveal').forEach(btn=>btn.addEventListener('click', e=>{
        const box = e.currentTarget.closest('.meaning');
        box.querySelector('.vi').classList.remove('hidden');
        e.currentTarget.remove();
      }));

      // progress
      const learned = load(LS_KEYS.learned, []);
      const learnedCount = learned.reduce((acc,g)=>acc+g.items.length,0);
      $('#progress').textContent = learnedCount;
      $('#streak').textContent = load(LS_KEYS.streak, 0);
    }

    /******************** Finish Day ********************/
    function finishDay(){
      const set = ensureTodaySet();
      const items = set.items.map(i=>({w:CORPUS[i].w, p:CORPUS[i].p, v:CORPUS[i].v}));
      const learned = load(LS_KEYS.learned, []);
      if(!learned.find(g=>g.date===set.date)){
        learned.push({date:set.date, items});
        save(LS_KEYS.learned, learned);
        markUsed(set.items);
        updateStreak();
        alert('Đã lưu 5 từ của ngày ' + set.date + ' vào danh sách đã học.');
      } else {
        alert('Ngày hôm nay đã được lưu trước đó.');
      }
      renderLesson(); renderLearned();
    }

    /******************** Learned List ********************/
    function renderLearned(){
      const learned = load(LS_KEYS.learned, []);
      const list = $('#learnedList'); list.innerHTML='';
      learned.sort((a,b)=> b.date.localeCompare(a.date));
      learned.forEach(group=>{
        const wrap = document.createElement('details');
        wrap.open = false;
        const tags = group.items.map(it=>`<span class="tag">${it.w} <span style="opacity:.6">(${it.v})</span></span>`).join('');
        wrap.innerHTML = `<summary>${group.date} — ${group.items.length} từ</summary><div style="margin-top:8px">${tags}</div>`;
        list.appendChild(wrap);
      });
    }

    // Search filter
    $('#search').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      $$('#learnedList details').forEach(d=>{
        if(!q){ d.classList.remove('hidden'); return; }
        const text = d.textContent.toLowerCase();
        d.classList.toggle('hidden', !text.includes(q));
      });
    });

    // Export CSV
    function exportCSV(){
      const learned = load(LS_KEYS.learned, []);
      const rows = [['date','word','phonetic','vi']];
      learned.forEach(g=>g.items.forEach(it=>rows.push([g.date,it.w,it.p||'',it.v])));
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='md5t_learned.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    /******************** Quiz ********************/
    function startQuiz(){
      const set = ensureTodaySet();
      const todayWords = set.items.map(i=>CORPUS[i]);
      if(todayWords.length < 5){ alert('Chưa có đủ từ cho hôm nay.'); return; }
      const questions = todayWords.map(it=>({
        prompt:`Từ nào khớp với nghĩa: \"${it.v}\"?`,
        correct: it.w,
        options: shuffle([it.w, ...shuffle(CORPUS.filter(x=>x.w!==it.w)).slice(0,3).map(x=>x.w)])
      }));
      renderQuiz(questions);
    }

    function renderQuiz(questions){
      const quizRoot = $('#quiz'); quizRoot.innerHTML='';
      let score = 0, answered = 0;

      questions.forEach((q, qi)=>{
        const card = document.createElement('div'); card.className='q-card';
        card.innerHTML = `<div><strong>Câu ${qi+1}</strong>: ${q.prompt}</div>`;
        const choices = document.createElement('div'); choices.className='choices';
        q.options.forEach(opt=>{
          const btn = document.createElement('button'); btn.className='choice'; btn.textContent=opt;
          btn.addEventListener('click',()=>{
            if(btn.classList.contains('correct') || btn.classList.contains('wrong')) return;
            answered++;
            if(opt===q.correct){ btn.classList.add('correct'); score++; }
            else { btn.classList.add('wrong'); [...choices.children].forEach(c=>{ if(c.textContent===q.correct) c.classList.add('correct'); }); }
            if(answered===questions.length){
              const res = document.createElement('div'); res.style.marginTop='14px';
              res.innerHTML = `<div class="card">✅ Hoàn thành! Điểm: <strong>${score}/${questions.length}</strong> — ${(score*100/questions.length).toFixed(0)}%</div>`;
              quizRoot.appendChild(res);
            }
          });
          choices.appendChild(btn);
        });
        card.appendChild(choices); quizRoot.appendChild(card);
      });
    }

    /******************** Tabs & Actions ********************/
    function switchTab(name){
      $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
      ['lesson','practice','learned'].forEach(id=>{
        $('#tab-'+id).classList.toggle('hidden', id!==name);
      });
    }

    $$('.tab').forEach(btn=>btn.addEventListener('click',()=>switchTab(btn.dataset.tab)));
    $('#finishDay').addEventListener('click', finishDay);
    $('#resetToday').addEventListener('click', ()=>{
      if(confirm('Chọn lại 5 từ hôm nay? (Không ảnh hưởng đến các ngày đã lưu)')){
        localStorage.removeItem(LS_KEYS.todaySet);
        renderLesson(); // regenerate
      }
    });
    $('#exportBtn').addEventListener('click', exportCSV);
    $('#clearAll').addEventListener('click', ()=>{
      if(confirm('XÓA TẤT CẢ dữ liệu (bài học, tiến độ, streak)?')){
        Object.values(LS_KEYS).forEach(k=>localStorage.removeItem(k));
        location.reload();
      }
    });
    $('#startQuiz').addEventListener('click', startQuiz);

    /******************** Init ********************/
    function init(){
      // Initialize streak on first finishDay, not on first load
      renderLesson();
      renderLearned();
    }
    init();
  </script>
</body>
</html>
