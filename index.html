<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mỗi ngày 5 từ tiếng Anh mới</title>
  <style>
    :root{
      --bg:#0f172a;      /* slate-900 */
      --card:#111827ee;  /* gray-900 */
      --text:#e5e7eb;    /* gray-200 */
      --muted:#94a3b8;   /* slate-400 */
      --accent:#22c55e;  /* green-500 */
      --primary:#60a5fa; /* blue-400 */
      --danger:#ef4444;  /* red-500 */
      --warning:#f59e0b; /* amber-500 */
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, #1f2937, transparent),
                  radial-gradient(1200px 800px at 110% 10%, #0b3b70, transparent),
                  var(--bg);
      min-height:100vh; overflow-x:hidden;
    }
    header{
      padding:24px 16px; position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);
      background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.6));
      border-bottom:1px solid #1f2937;
    }
    .container{max-width:1000px; margin:0 auto; padding:0 12px}
    h1{margin:0; font-size:clamp(20px,3.4vw,36px); letter-spacing:.2px}
    .sub{color:var(--muted); font-size:14px}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:8px}
    .pill{padding:6px 10px; border:1px solid #374151; border-radius:999px; color:var(--muted); font-size:12px}
    nav{display:flex; gap:8px; margin-top:14px}
    .tab{border:1px solid #334155; background:#0b1220; color:#cbd5e1; padding:10px 14px; border-radius:10px; cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#0a1a34,#0b1220); border-color:#3b82f6; color:white; box-shadow:0 0 0 2px #1d4ed8 inset}
    main{padding:24px 0 48px}

    .lesson-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:14px}
    .card{background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h3{margin:0 0 6px; font-size:22px}
    .phonetic{color:#a5b4fc}
    .meaning{margin-top:10px; padding:10px; border-radius:12px; background:#0b1220; border:1px dashed #334155; color:#e2e8f0; display:flex; justify-content:space-between; align-items:center}
    .meaning button{margin-left:10px}

    .btn{appearance:none; border:1px solid #334155; color:#e5e7eb; background:#0b1220; padding:10px 12px; border-radius:12px; cursor:pointer}
    .btn:hover{border-color:#475569}
    .btn.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8); border:none}
    .btn.success{background:linear-gradient(180deg,#22c55e,#16a34a); border:none}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706); border:none}
    .btn.ghost{background:transparent}

    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:14px 0}
    .muted{color:var(--muted)}

    .list{display:grid; gap:10px}
    details{background:var(--card); border:1px solid #1f2937; border-radius:14px; padding:10px 12px}
    summary{cursor:pointer; font-weight:600}
    .tag{display:inline-block; margin:6px 6px 0 0; padding:6px 10px; background:#0b1220; border:1px solid #334155; border-radius:999px; font-size:12px}

    .quiz{max-width:700px}
    .q-card{background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px}
    .choices{display:grid; gap:10px; margin-top:10px}
    .choice{padding:10px 12px; border:1px solid #334155; border-radius:12px; cursor:pointer; background:#0b1220}
    .choice.correct{border-color:var(--accent)}
    .choice.wrong{border-color:var(--danger)}

    .footer{margin-top:28px; color:var(--muted); font-size:12px; text-align:center}
    .right{margin-left:auto}
    .hidden{display:none}
    input[type="search"]{background:#0b1220; border:1px solid #334155; color:#e5e7eb; border-radius:10px; padding:10px; min-width:220px}

    /* <CHANGE> Modern toast notification styling */
    #toast {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 2000;
      min-width: 320px;
      max-width: 400px;
      background: rgba(40, 40, 40, 0.95);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
      display: none;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      transform: translateX(100%);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #toast.show {
      display: flex;
      transform: translateX(0);
    }

    .toast-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: bold;
      color: white;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .toast-icon.success {
      background: linear-gradient(135deg, #22c55e, #16a34a);
    }

    .toast-icon.error {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .toast-icon.warning {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .toast-icon.info {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    .toast-content {
      flex: 1;
      min-width: 0;
    }

    .toast-title {
      font-size: 15px;
      font-weight: 600;
      color: #ffffff;
      margin: 0 0 4px 0;
      line-height: 1.3;
    }

    .toast-message {
      font-size: 14px;
      color: #d1d5db;
      margin: 0;
      line-height: 1.4;
      word-wrap: break-word;
    }

    @media (max-width: 480px) {
      #toast {
        left: 16px;
        right: 16px;
        min-width: auto;
        max-width: none;
      }
    }
    :root{
      --bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      --card: rgba(30, 41, 59, 0.8);
      --card-hover: rgba(51, 65, 85, 0.9);
      --text: #f1f5f9;
      --text-secondary: #cbd5e1;
      --muted: #94a3b8;
      --accent: #10b981;
      --accent-hover: #059669;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #22c55e;
      --border: rgba(148, 163, 184, 0.2);
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 20px 40px -10px rgba(0, 0, 0, 0.4);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      color: var(--text);
      background: var(--bg);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.6;
    }

    /* Enhanced Header */
    header {
      padding: 2rem 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
      background: rgba(15, 23, 42, 0.9);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    h1 {
      font-family: 'Poppins', sans-serif;
      font-size: clamp(1.8rem, 4vw, 2.5rem);
      font-weight: 700;
      background: linear-gradient(135deg, #3b82f6, #10b981);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1rem;
      text-align: center;
    }

    .row {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 1.5rem;
    }

    .pill {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: 50px;
      color: var(--text-secondary);
      font-size: 0.875rem;
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .pill:hover {
      background: rgba(51, 65, 85, 0.8);
      transform: translateY(-2px);
    }

    /* Enhanced Navigation */
    nav {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .tab {
      border: 1px solid var(--border);
      background: rgba(30, 41, 59, 0.6);
      color: var(--text-secondary);
      padding: 0.75rem 1.25rem;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .tab::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }

    .tab:hover::before {
      left: 100%;
    }

    .tab:hover {
      background: var(--card-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .tab.active {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-color: var(--primary);
      color: white;
      box-shadow: var(--shadow);
    }

    .right {
      margin-left: auto;
    }

    main {
      padding: 2rem 0 3rem;
    }

    /* Enhanced Cards */
    .lesson-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .card:hover {
      background: var(--card-hover);
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .card:hover::before {
      opacity: 1;
    }

    .card h3 {
      font-family: 'Poppins', sans-serif;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    .phonetic {
      color: #a5b4fc;
      font-style: italic;
      margin-bottom: 1rem;
      font-size: 1rem;
    }

    .meaning {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px dashed var(--border);
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    /* Enhanced Buttons */
    .btn {
      appearance: none;
      border: 1px solid var(--border);
      color: var(--text);
      background: rgba(30, 41, 59, 0.8);
      padding: 0.75rem 1.25rem;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }

    .btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      border: none;
      color: white;
    }

    .btn.success {
      background: linear-gradient(135deg, var(--success), var(--accent-hover));
      border: none;
      color: white;
    }

    .btn.warn {
      background: linear-gradient(135deg, var(--warning), #d97706);
      border: none;
      color: white;
    }

    .btn.ghost {
      background: transparent;
      border-color: var(--border);
    }

    /* Enhanced Toolbar */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin: 2rem 0;
      padding: 1.5rem;
      background: rgba(30, 41, 59, 0.4);
      border-radius: 16px;
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }

    .muted {
      color: var(--muted);
      font-size: 0.875rem;
    }

    /* Enhanced Lists */
    .list {
      display: grid;
      gap: 1rem;
      margin-top: 2rem;
    }

    details {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1rem 1.25rem;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    details:hover {
      background: var(--card-hover);
      box-shadow: var(--shadow);
    }

    summary {
      cursor: pointer;
      font-weight: 600;
      padding: 0.5rem 0;
      color: var(--text);
      transition: color 0.3s ease;
    }

    summary:hover {
      color: var(--primary);
    }

    .tag {
      display: inline-block;
      margin: 0.5rem 0.5rem 0 0;
      padding: 0.5rem 1rem;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid var(--border);
      border-radius: 50px;
      font-size: 0.75rem;
      transition: all 0.3s ease;
    }

    .tag:hover {
      background: var(--card-hover);
      transform: translateY(-1px);
    }

    /* Enhanced Quiz */
    .quiz {
      max-width: 800px;
      margin: 0 auto;
    }

    .q-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .choices {
      display: grid;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .choice {
      padding: 1rem 1.25rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.8);
      color: var(--text);
      transition: all 0.3s ease;
      text-align: left;
    }

    .choice:hover {
      background: var(--card-hover);
      border-color: var(--primary);
      transform: translateX(5px);
    }

    .choice.correct {
      border-color: var(--success);
      background: rgba(34, 197, 94, 0.2);
    }

    .choice.wrong {
      border-color: var(--danger);
      background: rgba(239, 68, 68, 0.2);
    }

    /* Enhanced Modal */
    #authModal {
      backdrop-filter: blur(10px);
    }

    #authModalContent {
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(20px);
    }

    /* Enhanced Form Elements */
    input[type="search"], input[type="email"], input[type="password"] {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      min-width: 250px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    input[type="search"]:focus, input[type="email"]:focus, input[type="password"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Enhanced Toast */
    #toast {
      background: var(--card) !important;
      border: 1px solid var(--border);
      backdrop-filter: blur(20px);
      box-shadow: var(--shadow-lg);
    }

    /* Footer */
    .footer {
      margin-top: 3rem;
      color: var(--muted);
      font-size: 0.875rem;
      text-align: center;
      padding: 2rem;
      border-top: 1px solid var(--border);
      background: rgba(30, 41, 59, 0.3);
    }

    .hidden {
      display: none !important;
    }

    /* Confirm popup styles */
    #logoutConfirmPopup {
      position: fixed;
      z-index: 3000;
      top: 0; left: 0; width: 100vw; height: 100vh;
      display: none;
    }
    #logoutConfirmPopup .confirm-overlay {
      position: absolute;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.35);
    }
    #logoutConfirmPopup .confirm-box {
      position: absolute;
      top: 50%; left: 50%; transform: translate(-50%,-50%);
      background: #fff;
      color: #222;
      border-radius: 14px;
      min-width: 320px;
      box-shadow: 0 8px 32px #0005;
      padding: 32px 28px 22px 28px;
      text-align: center;
      animation: popupIn .25s;
    }
    #logoutConfirmPopup .confirm-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    #logoutConfirmPopup .confirm-msg {
      font-size: 16px;
      margin-bottom: 18px;
    }
    #logoutConfirmPopup .confirm-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
    }
    @keyframes popupIn {
      from { opacity: 0; transform: translate(-50%,-60%) scale(0.95); }
      to   { opacity: 1; transform: translate(-50%,-50%) scale(1); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 0 0.5rem;
      }
      
      .lesson-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .toolbar .btn {
        width: 100%;
        text-align: center;
      }
      
      nav {
        flex-direction: column;
      }
      
      .tab {
        width: 100%;
        text-align: center;
      }
    }

    /* Animation for page load */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card, .toolbar, details {
      animation: fadeInUp 0.6s ease forwards;
    }

    .card:nth-child(2) { animation-delay: 0.1s; }
    .card:nth-child(3) { animation-delay: 0.2s; }
    .card:nth-child(4) { animation-delay: 0.3s; }
    .card:nth-child(5) { animation-delay: 0.4s; }

  </style>
</head>
<body>
  <header>
  <!-- <CHANGE> Updated toast notification structure -->
  <div id="toast">
    <div class="toast-icon" id="toastIcon"></div>
    <div class="toast-content">
      <div class="toast-title" id="toastTitle"></div>
      <div class="toast-message" id="toastMessage"></div>
    </div>
  </div>
    <!-- Auth Modal (new, đơn giản) -->
    <div id="authModal" class="hidden" style="position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;">
      <div id="authModalContent" style="background:#1e293b;padding:32px 24px;border-radius:16px;min-width:320px;max-width:90vw;box-shadow:0 8px 32px #000a;position:relative;">
        <span id="closeAuth" style="position:absolute;top:8px;right:16px;font-size:28px;cursor:pointer;color:#fff">&times;</span>
        <h2 style="margin-top:0">Đăng nhập / Đăng ký</h2>
        <form id="authForm">
          <input id="authEmail" type="email" placeholder="Email" required style="width:100%;margin-bottom:10px;padding:10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb" />
          <input id="authPassword" type="password" placeholder="Mật khẩu" required minlength="6" style="width:100%;margin-bottom:10px;padding:10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb" />
          <button type="submit" class="btn primary" style="width:100%;margin-bottom:8px">Đăng nhập</button>
  </form>
  <button id="googleSignIn" type="button" class="btn" style="width:100%;background:#fff;color:#222;border:1px solid #ccc;margin-bottom:8px"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="height:18px;vertical-align:middle;margin-right:8px">Đăng nhập với Google</button>
        </form>
        <div style="text-align:center;margin-bottom:8px">
          <span id="toggleAuthMode" style="color:#60a5fa;cursor:pointer;font-size:14px">Chưa có tài khoản? Đăng ký</span>
        </div>
        <div id="authError" style="color:#ef4444;text-align:center;font-size:14px;min-height:20px"></div>
      </div>
    </div>
    <div class="container">
      <h1>Mỗi ngày 5 từ tiếng Anh mới</h1>
      <div class="row">
        <div class="pill" id="todayLabel">Hôm nay: —</div>
        <div class="pill">Tiến độ: <span id="progress">0</span> / <span id="totalWords">0</span> từ</div>
        <div class="pill">Ngày liên tiếp: <span id="streak">0</span> 🔥</div>
      </div>


        <nav>
          <button class="tab active" data-tab="lesson">📚 Bài học hôm nay</button>
          <button class="tab" data-tab="practice">🧠 Luyện tập</button>
          <button class="tab" data-tab="learned">✅ Từ đã học</button>
          <button id="openAuth" class="btn ghost right" style="margin-left:auto">Đăng nhập</button>
          <button id="logoutBtn" class="btn warn right" style="margin-left:8px;display:none">Đăng xuất</button>
        </nav>
    <!-- LESSON TAB -->
    <section id="tab-lesson">
      <div class="toolbar">
        <button id="finishDay" class="btn success">Đánh dấu hoàn thành ngày học</button>
        <button id="resetToday" class="btn warn">Chọn lại 5 từ hôm nay</button>
        <span class="muted right">Mẹo: Bấm vào "Hiện nghĩa" để tự kiểm tra trước khi xem đáp án.</span>
      </div>
      <div id="lesson" class="lesson-grid"></div>
    </section>

    <!-- PRACTICE TAB -->
    <section id="tab-practice" class="hidden">
      <div class="toolbar">
        <button id="startQuiz" class="btn primary">Bắt đầu bài luyện tập</button>
        <span class="muted">5 câu trắc nghiệm dựa trên 5 từ hôm nay.</span>
      </div>
      <div id="quiz" class="quiz"></div>
    </section>

    <!-- LEARNED TAB -->
    <section id="tab-learned" class="hidden">
      <div class="toolbar">
        <input id="search" type="search" placeholder="Tìm từ hoặc nghĩa đã học..." />
        <button id="exportBtn" class="btn">Tải CSV tất cả từ đã học</button>
        <button id="clearAll" class="btn warn">Xóa TẤT CẢ dữ liệu</button>
      </div>
      <div id="learnedList" class="list"></div>
    </section>

    <div class="footer">Code by Dang Thanh Ha</div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    // Cấu hình Firebase cho web app
    const firebaseConfig = {
      apiKey: "AIzaSyCg9wLWjLkwf5mCaRsAcp3obVi-CKXoH-E",
      authDomain: "learning-english-56f73.firebaseapp.com",
      projectId: "learning-english-56f73",
      storageBucket: "learning-english-56f73.appspot.com",
      messagingSenderId: "339132124762",
      appId: "1:339132124762:web:48a113f910f12fd84a1263",
      measurementId: "G-5FB87HKJGY"
    };
    firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
    // Firestore helpers
    async function saveLearnedToFirestore(uid, learned) {
      if (!uid) return;
      try {
        await db.collection('users').doc(uid).set({ learned }, { merge: true });
      } catch (e) { console.error('Lỗi lưu Firestore:', e); }
    }
    async function loadLearnedFromFirestore(uid) {
      if (!uid) return null;
      try {
        const doc = await db.collection('users').doc(uid).get();
        return doc.exists && doc.data().learned ? doc.data().learned : [];
      } catch (e) { console.error('Lỗi tải Firestore:', e); return null; }
    }

    // UI logic cho popup đăng nhập/đăng ký
    // Popup đăng nhập/đăng ký, Google sign-in, logout, toast
    (function() {
      const authModal = document.getElementById('authModal');
      const authModalContent = document.getElementById('authModalContent');
      const openAuthBtn = document.getElementById('openAuth');
      const logoutBtn = document.getElementById('logoutBtn');
      const closeAuthBtn = document.getElementById('closeAuth');
      const authForm = document.getElementById('authForm');
      const authEmail = document.getElementById('authEmail');
      const authPassword = document.getElementById('authPassword');
      const toggleAuthMode = document.getElementById('toggleAuthMode');
      const authError = document.getElementById('authError');
      const googleSignIn = document.getElementById('googleSignIn');
      const toast = document.getElementById('toast');
      const toastIcon = document.getElementById('toastIcon');
      const toastTitle = document.getElementById('toastTitle');
      const toastMessage = document.getElementById('toastMessage');
      let isSignUp = false;

      function showModal() {
        authModal.style.display = 'flex';
        authModal.classList.remove('hidden');
      }
      function hideModal() {
        authModal.style.display = 'none';
        authModal.classList.add('hidden');
      }
      
      // <CHANGE> Enhanced toast function with modern design and animations
      function showToast(title, message, type = 'info') {
        // Set icon and styling based on type
        toastIcon.className = `toast-icon ${type}`;
        switch(type) {
          case 'success':
            toastIcon.innerHTML = '✓';
            break;
          case 'error':
            toastIcon.innerHTML = '!';
            break;
          case 'warning':
            toastIcon.innerHTML = '⚠';
            break;
          default:
            toastIcon.innerHTML = 'i';
        }
        
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        
        // Show toast with animation
        toast.classList.add('show');
        
        // Auto hide after 4 seconds
        setTimeout(() => {
          toast.classList.remove('show');
        }, 4000);
      }

      openAuthBtn.onclick = () => {
        showModal();
        authError.textContent = '';
        isSignUp = false;
        toggleAuthMode.textContent = 'Chưa có tài khoản? Đăng ký';
        authForm.querySelector('button[type="submit"]').textContent = 'Đăng nhập';
      };
      closeAuthBtn.onclick = hideModal;
      authModal.onclick = function(e) {
        if (e.target === authModal) hideModal();
      };
      toggleAuthMode.onclick = () => {
        isSignUp = !isSignUp;
        if(isSignUp) {
          toggleAuthMode.textContent = 'Đã có tài khoản? Đăng nhập';       
          authForm.querySelector('button[type="submit"]').textContent = 'Đăng ký';
        } else {
          toggleAuthMode.textContent = 'Chưa có tài khoản? Đăng ký';
          authForm.querySelector('button[type="submit"]').textContent = 'Đăng nhập';
        }
        authError.textContent = '';
      };
      authForm.onsubmit = async e => {
        e.preventDefault();
        authError.textContent = '';
        const email = authEmail.value.trim();
        const pass = authPassword.value;
        try {
          if(isSignUp) {
            await auth.createUserWithEmailAndPassword(email, pass);
            showToast('Thành công', 'Đăng ký tài khoản thành công!', 'success');
          } else {
            await auth.signInWithEmailAndPassword(email, pass);
            showToast('Thành công', 'Đăng nhập thành công!', 'success');
          }
          hideModal();
        } catch(err) {
          authError.textContent = err.message.replace('Firebase: ', '');
          showToast('Lỗi', err.message.replace('Firebase: ', ''), 'error');
        }
      };
      // Google sign-in
      googleSignIn.onclick = async function() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
          await auth.signInWithPopup(provider);
          showToast('Thành công', 'Đăng nhập Google thành công!', 'success');
          hideModal();
        } catch(err) {
          authError.textContent = err.message.replace('Firebase: ', '');
          showToast('Lỗi', err.message.replace('Firebase: ', ''), 'error');
        }
      };
      // Logout
      // Custom confirm popup
      function showConfirmLogout(onConfirm) {
        let popup = document.getElementById('logoutConfirmPopup');
        if (!popup) {
          popup = document.createElement('div');
          popup.id = 'logoutConfirmPopup';
          popup.innerHTML = `
            <div class="confirm-overlay"></div>
            <div class="confirm-box">
              <div class="confirm-title">Xác nhận đăng xuất</div>
              <div class="confirm-msg">Bạn có chắc chắn muốn đăng xuất không?</div>
              <div class="confirm-actions">
                <button id="confirmLogoutBtn" class="btn primary">Đồng ý</button>
                <button id="cancelLogoutBtn" class="btn warn">Hủy</button>
              </div>
            </div>
          `;
          document.body.appendChild(popup);
        }
        popup.style.display = 'block';
        popup.querySelector('#confirmLogoutBtn').onclick = () => {
          popup.style.display = 'none';
          onConfirm();
        };
        popup.querySelector('#cancelLogoutBtn').onclick = () => {
          popup.style.display = 'none';
        };
      }

      logoutBtn.onclick = async function() {
        showConfirmLogout(async () => {
          await auth.signOut();
          showToast('Đăng xuất thành công!', 'success');
        });
      };
      // Hiển thị nút đăng nhập/đăng xuất phù hợp
      // Khi trạng thái đăng nhập thay đổi, load dữ liệu Firestore nếu có
      auth.onAuthStateChanged(async user => {
        if(user) {
          openAuthBtn.style.display = 'none';
          logoutBtn.style.display = 'inline-block';
          // Load "learned" từ Firestore
          const learned = await loadLearnedFromFirestore(user.uid);
          if (learned) {
            localStorage.setItem(LS_KEYS.learned, JSON.stringify(learned));
            renderLearned();
          }
        } else {
          openAuthBtn.style.display = 'inline-block';
          logoutBtn.style.display = 'none';
        }
      });
    })();
    /******************** Data ********************/
    // Load corpus từ file ngoài (corpus.json)
    let CORPUS = [];
    async function loadCorpus() {
      try {
        const res = await fetch('corpus_translated.json');
        if (!res.ok) throw new Error('Không tải được corpus_translated.json');
        CORPUS = await res.json();
      } catch (e) {
        // fallback: dữ liệu mẫu nếu không tải được file ngoài
        CORPUS = [
          {w:'abandon', p:'/əˈbændən/', v:'từ bỏ; bỏ rơi', h:'They had to abandon the car.', h_vi:'Họ đã phải bỏ chiếc xe.'},
          {w:'ability', p:'/əˈbɪləti/', v:'khả năng', h:'Her ability is impressive.', h_vi:'Khả năng của cô ấy thật ấn tượng.'}
        ];
        console.error('Lỗi tải corpus:', e);
      }
    }

    const LS_KEYS = {
      todaySet: 'md5t_today_set',        // {date:'YYYY-MM-DD', items:[indexes]}
      learned: 'md5t_learned',           // [{date, items:[{w,p,v}]}]
      usedIndex: 'md5t_used_indexes',    // number[] to avoid repeat
      streak: 'md5t_streak',
      lastDate: 'md5t_last_date'
    };

    /******************** Utilities ********************/
    const fmtDate = (d=new Date()) => d.toISOString().slice(0,10);
    const today = fmtDate();
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function load(key, fallback){
      try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch{ return fallback }
    }
    function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] }
      return arr;
    }

    /******************** Today set logic ********************/
    function ensureTodaySet(){
      let todaySet = load(LS_KEYS.todaySet, null);
      if(!todaySet || todaySet.date !== today){
        // pick 5 new indices not used yet
        const used = new Set(load(LS_KEYS.usedIndex, []));
        const available = CORPUS.map((_,i)=>i).filter(i=>!used.has(i));
        let picks = [];
        if(available.length >= 5){
          shuffle(available); picks = available.slice(0,5);
        }else{
          // not enough fresh words: include remaining + random from start
          const rest = available.slice();
          const need = 5 - rest.length;
          const pool = CORPUS.map((_,i)=>i);
          shuffle(pool);
          picks = rest.concat(pool.slice(0,need));
        }
        todaySet = {date: today, items: picks};
        save(LS_KEYS.todaySet, todaySet);
      }
      return todaySet;
    }

    function markUsed(indexes){
      const used = new Set(load(LS_KEYS.usedIndex, []));
      indexes.forEach(i=>used.add(i));
      save(LS_KEYS.usedIndex, Array.from(used));
    }

    function updateStreak(){
      const last = load(LS_KEYS.lastDate, null);
      let s = load(LS_KEYS.streak, 0);
      if(last){
        const diff = (new Date(today) - new Date(last))/(1000*3600*24);
        if(diff === 1){ s += 1; }
        else if(diff > 1){ s = 1; }
      }else{ s = 1; }
      save(LS_KEYS.streak, s); save(LS_KEYS.lastDate, today); return s;
    }

    /******************** Render Lesson ********************/
    function renderLesson(){
      const set = ensureTodaySet();
      $('#todayLabel').textContent = 'Hôm nay: ' + set.date;
      $('#totalWords').textContent = CORPUS.length;

      const frag = document.createDocumentFragment();
      set.items.forEach((idx, order)=>{
        const it = CORPUS[idx];
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${order+1}. ${it.w}</h3>
          <div class="phonetic">${it.p || ''}</div>
          <div class="meaning"><span class="vi hidden">${it.v}</span>
            <button class="btn reveal">Hiện nghĩa</button>
          </div>
          <div class="muted" style="margin-top:8px">Ví dụ: <em>${it.h || ''}</em>
            ${it.h_vi ? `<button class='btn btn-xs reveal-example' style='margin-left:10px'>Hiện nghĩa ví dụ</button> <span class='example-vi hidden' style='color:#16a34a'>${it.h_vi}</span>` : ''}
          </div>
        `;
        frag.appendChild(card);
      });
      const root = $('#lesson'); root.innerHTML=''; root.appendChild(frag);
      $$('#lesson .reveal').forEach(btn=>btn.addEventListener('click', e=>{
        const box = e.currentTarget.closest('.meaning');
        box.querySelector('.vi').classList.remove('hidden');
        e.currentTarget.remove();
      }));
      $$('#lesson .reveal-example').forEach(btn=>btn.addEventListener('click', e=>{
        const box = e.currentTarget.closest('.muted');
        box.querySelector('.example-vi').classList.remove('hidden');
        e.currentTarget.remove();
      }));

      // progress
      const learned = load(LS_KEYS.learned, []);
      const learnedCount = learned.reduce((acc,g)=>acc+g.items.length,0);
      $('#progress').textContent = learnedCount;
      $('#streak').textContent = load(LS_KEYS.streak, 0);
    }

    /******************** Finish Day ********************/
    async function finishDay(){
      const set = ensureTodaySet();
      const items = set.items.map(i=>({w:CORPUS[i].w, p:CORPUS[i].p, v:CORPUS[i].v}));
      let learned = load(LS_KEYS.learned, []);
      if(!learned.find(g=>g.date===set.date)){
        learned.push({date:set.date, items});
        save(LS_KEYS.learned, learned);
        markUsed(set.items);
        updateStreak();
        // Nếu đã đăng nhập thì lưu lên Firestore
        if(auth.currentUser) await saveLearnedToFirestore(auth.currentUser.uid, learned);
        // <CHANGE> Updated to use new toast system
        showToast('Hoàn thành!', `Đã lưu 5 từ của ngày ${set.date} vào danh sách đã học.`, 'success');
      } else {
        // <CHANGE> Updated to use new toast system
        showToast('Thông báo', 'Ngày hôm nay đã được lưu trước đó.', 'warning');
      }
      renderLesson(); renderLearned();
    }

    /******************** Learned List ********************/
    function renderLearned(){
      const learned = load(LS_KEYS.learned, []);
      const list = $('#learnedList'); list.innerHTML='';
      learned.sort((a,b)=> b.date.localeCompare(a.date));
      learned.forEach(group=>{
        const wrap = document.createElement('details');
        wrap.open = false;
        const tags = group.items.map(it=>`<span class="tag">${it.w} <span style="opacity:.6">(${it.v})</span></span>`).join('');
        wrap.innerHTML = `<summary>${group.date} — ${group.items.length} từ</summary><div style="margin-top:8px">${tags}</div>`;
        list.appendChild(wrap);
      });
    }

    // Search filter
    $('#search').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      $$('#learnedList details').forEach(d=>{
        if(!q){ d.classList.remove('hidden'); return; }
        const text = d.textContent.toLowerCase();
        d.classList.toggle('hidden', !text.includes(q));
      });
    });

    // Export CSV
    function exportCSV(){
      const learned = load(LS_KEYS.learned, []);
      const rows = [['date','word','phonetic','vi']];
      learned.forEach(g=>g.items.forEach(it=>rows.push([g.date,it.w,it.p||'',it.v])));
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='md5t_learned.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    /******************** Quiz ********************/
    function startQuiz(){
      const set = ensureTodaySet();
      const todayWords = set.items.map(i=>CORPUS[i]);
      if(todayWords.length < 5){ 
        // <CHANGE> Updated to use new toast system
        showToast('Lỗi', 'Chưa có đủ từ cho hôm nay.', 'error'); 
        return; 
      }
      const questions = todayWords.map(it=>({
        prompt:`Từ nào khớp với nghĩa: \"${it.v}\"?`,
        correct: it.w,
        options: shuffle([it.w, ...shuffle(CORPUS.filter(x=>x.w!==it.w)).slice(0,3).map(x=>x.w)])
      }));
      renderQuiz(questions);
    }

    function renderQuiz(questions){
      const quizRoot = $('#quiz'); quizRoot.innerHTML='';
      let score = 0, answered = 0;

      questions.forEach((q, qi)=>{
        const card = document.createElement('div'); card.className='q-card';
        card.innerHTML = `<div><strong>Câu ${qi+1}</strong>: ${q.prompt}</div>`;
        const choices = document.createElement('div'); choices.className='choices';
        q.options.forEach(opt=>{
          const btn = document.createElement('button'); btn.className='choice'; btn.textContent=opt;
          btn.addEventListener('click',()=>{
            if(btn.classList.contains('correct') || btn.classList.contains('wrong')) return;
            answered++;
            if(opt===q.correct){ btn.classList.add('correct'); score++; }
            else { btn.classList.add('wrong'); [...choices.children].forEach(c=>{ if(c.textContent===q.correct) c.classList.add('correct'); }); }
            if(answered===questions.length){
              const res = document.createElement('div'); res.style.marginTop='14px';
              res.innerHTML = `<div class="card">✅ Hoàn thành! Điểm: <strong>${score}/${questions.length}</strong> — ${(score*100/questions.length).toFixed(0)}%</div>`;
              quizRoot.appendChild(res);
              // <CHANGE> Added toast notification for quiz completion
              showToast('Hoàn thành bài tập!', `Bạn đạt ${score}/${questions.length} điểm (${(score*100/questions.length).toFixed(0)}%)`, 'success');
            }
          });
          choices.appendChild(btn);
        });
        card.appendChild(choices); quizRoot.appendChild(card);
      });
    }

    /******************** Tabs & Actions ********************/
    function switchTab(name){
      $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
      ['lesson','practice','learned'].forEach(id=>{
        $('#tab-'+id).classList.toggle('hidden', id!==name);
      });
    }

    $$('.tab').forEach(btn=>btn.addEventListener('click',()=>switchTab(btn.dataset.tab)));
    $('#finishDay').addEventListener('click', finishDay);
    $('#resetToday').addEventListener('click', ()=>{
      if(confirm('Chọn lại 5 từ hôm nay? (Không ảnh hưởng đến các ngày đã lưu)')){
        localStorage.removeItem(LS_KEYS.todaySet);
        renderLesson(); // regenerate
        // <CHANGE> Added toast notification for reset
        showToast('Đã reset', 'Đã chọn lại 5 từ mới cho hôm nay.', 'info');
      }
    });
    $('#exportBtn').addEventListener('click', exportCSV);
    $('#clearAll').addEventListener('click', ()=>{
      if(confirm('XÓA TẤT CẢ dữ liệu (bài học, tiến độ, streak)?')){
        Object.values(LS_KEYS).forEach(k=>localStorage.removeItem(k));
        location.reload();
      }
    });
    $('#startQuiz').addEventListener('click', startQuiz);

    /******************** Init ********************/
    async function init(){
      await loadCorpus();
      renderLesson();
      renderLearned();
    }
    init();
  </script>
</body>
</html>
