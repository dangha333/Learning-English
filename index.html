<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Má»—i ngÃ y 5 tá»« tiáº¿ng Anh má»›i</title>
  <style>
    :root{
      --bg:#0f172a;      /* slate-900 */
      --card:#111827ee;  /* gray-900 */
      --text:#e5e7eb;    /* gray-200 */
      --muted:#94a3b8;   /* slate-400 */
      --accent:#22c55e;  /* green-500 */
      --primary:#60a5fa; /* blue-400 */
      --danger:#ef4444;  /* red-500 */
      --warning:#f59e0b; /* amber-500 */
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, #1f2937, transparent),
                  radial-gradient(1200px 800px at 110% 10%, #0b3b70, transparent),
                  var(--bg);
      min-height:100vh; overflow-x:hidden;
    }
    header{
      padding:24px 16px; position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);
      background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.6));
      border-bottom:1px solid #1f2937;
    }
    .container{max-width:1000px; margin:0 auto; padding:0 12px}
    h1{margin:0; font-size:clamp(20px,3.4vw,36px); letter-spacing:.2px}
    .sub{color:var(--muted); font-size:14px}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:8px}
    .pill{padding:6px 10px; border:1px solid #374151; border-radius:999px; color:var(--muted); font-size:12px}
    nav{display:flex; gap:8px; margin-top:14px}
    .tab{border:1px solid #334155; background:#0b1220; color:#cbd5e1; padding:10px 14px; border-radius:10px; cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#0a1a34,#0b1220); border-color:#3b82f6; color:white; box-shadow:0 0 0 2px #1d4ed8 inset}
    main{padding:24px 0 48px}

    .lesson-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:14px}
    .card{background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h3{margin:0 0 6px; font-size:22px}
    .phonetic{color:#a5b4fc}
    .meaning{margin-top:10px; padding:10px; border-radius:12px; background:#0b1220; border:1px dashed #334155; color:#e2e8f0; display:flex; justify-content:space-between; align-items:center}
    .meaning button{margin-left:10px}

    .btn{appearance:none; border:1px solid #334155; color:#e5e7eb; background:#0b1220; padding:10px 12px; border-radius:12px; cursor:pointer}
    .btn:hover{border-color:#475569}
    .btn.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8); border:none}
    .btn.success{background:linear-gradient(180deg,#22c55e,#16a34a); border:none}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706); border:none}
    .btn.ghost{background:transparent}

    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:14px 0}
    .muted{color:var(--muted)}

    .list{display:grid; gap:10px}
    details{background:var(--card); border:1px solid #1f2937; border-radius:14px; padding:10px 12px}
    summary{cursor:pointer; font-weight:600}
    .tag{display:inline-block; margin:6px 6px 0 0; padding:6px 10px; background:#0b1220; border:1px solid #334155; border-radius:999px; font-size:12px}

    .quiz{max-width:700px}
    .q-card{background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px}
    .choices{display:grid; gap:10px; margin-top:10px}
    .choice{padding:10px 12px; border:1px solid #334155; border-radius:12px; cursor:pointer; background:#0b1220}
    .choice.correct{border-color:var(--accent)}
    .choice.wrong{border-color:var(--danger)}

    .footer{margin-top:28px; color:var(--muted); font-size:12px; text-align:center}
    .right{margin-left:auto}
    .hidden{display:none}
    input[type="search"]{background:#0b1220; border:1px solid #334155; color:#e5e7eb; border-radius:10px; padding:10px; min-width:220px}
  </style>
</head>
<body>
  <header>
  <!-- Toast notification -->
  <div id="toast" style="position:fixed;top:24px;right:24px;z-index:2000;min-width:180px;max-width:90vw;padding:14px 24px;background:#222;border-radius:8px;color:#fff;font-size:16px;box-shadow:0 4px 24px #0007;display:none;align-items:center;gap:8px"></div>
    <!-- Auth Modal (new, Ä‘Æ¡n giáº£n) -->
    <div id="authModal" class="hidden" style="position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;">
      <div id="authModalContent" style="background:#1e293b;padding:32px 24px;border-radius:16px;min-width:320px;max-width:90vw;box-shadow:0 8px 32px #000a;position:relative;">
        <span id="closeAuth" style="position:absolute;top:8px;right:16px;font-size:28px;cursor:pointer;color:#fff">&times;</span>
        <h2 style="margin-top:0">ÄÄƒng nháº­p / ÄÄƒng kÃ½</h2>
        <form id="authForm">
          <input id="authEmail" type="email" placeholder="Email" required style="width:100%;margin-bottom:10px;padding:10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb" />
          <input id="authPassword" type="password" placeholder="Máº­t kháº©u" required minlength="6" style="width:100%;margin-bottom:10px;padding:10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb" />
          <button type="submit" class="btn primary" style="width:100%;margin-bottom:8px">ÄÄƒng nháº­p</button>
  </form>
  <button id="googleSignIn" type="button" class="btn" style="width:100%;background:#fff;color:#222;border:1px solid #ccc;margin-bottom:8px"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="height:18px;vertical-align:middle;margin-right:8px">ÄÄƒng nháº­p vá»›i Google</button>
        </form>
        <div style="text-align:center;margin-bottom:8px">
          <span id="toggleAuthMode" style="color:#60a5fa;cursor:pointer;font-size:14px">ChÆ°a cÃ³ tÃ i khoáº£n? ÄÄƒng kÃ½</span>
        </div>
        <div id="authError" style="color:#ef4444;text-align:center;font-size:14px;min-height:20px"></div>
      </div>
    </div>
    <div class="container">
      <h1>Má»—i ngÃ y 5 tá»« tiáº¿ng Anh má»›i</h1>
      <div class="row">
        <div class="pill" id="todayLabel">HÃ´m nay: â€”</div>
        <div class="pill">Tiáº¿n Ä‘á»™: <span id="progress">0</span> / <span id="totalWords">0</span> tá»«</div>
        <div class="pill">NgÃ y liÃªn tiáº¿p: <span id="streak">0</span> ğŸ”¥</div>
      </div>


        <nav>
          <button class="tab active" data-tab="lesson">ğŸ“š BÃ i há»c hÃ´m nay</button>
          <button class="tab" data-tab="practice">ğŸ§  Luyá»‡n táº­p</button>
          <button class="tab" data-tab="learned">âœ… Tá»« Ä‘Ã£ há»c</button>
          <button id="openAuth" class="btn ghost right" style="margin-left:auto">ÄÄƒng nháº­p</button>
          <button id="logoutBtn" class="btn warn right" style="margin-left:8px;display:none">ÄÄƒng xuáº¥t</button>
        </nav>
    <!-- LESSON TAB -->
    <section id="tab-lesson">
      <div class="toolbar">
        <button id="finishDay" class="btn success">ÄÃ¡nh dáº¥u hoÃ n thÃ nh ngÃ y há»c</button>
        <button id="resetToday" class="btn warn">Chá»n láº¡i 5 tá»« hÃ´m nay</button>
        <span class="muted right">Máº¹o: Báº¥m vÃ o "Hiá»‡n nghÄ©a" Ä‘á»ƒ tá»± kiá»ƒm tra trÆ°á»›c khi xem Ä‘Ã¡p Ã¡n.</span>
      </div>
      <div id="lesson" class="lesson-grid"></div>
    </section>

    <!-- PRACTICE TAB -->
    <section id="tab-practice" class="hidden">
      <div class="toolbar">
        <button id="startQuiz" class="btn primary">Báº¯t Ä‘áº§u bÃ i luyá»‡n táº­p</button>
        <span class="muted">5 cÃ¢u tráº¯c nghiá»‡m dá»±a trÃªn 5 tá»« hÃ´m nay.</span>
      </div>
      <div id="quiz" class="quiz"></div>
    </section>

    <!-- LEARNED TAB -->
    <section id="tab-learned" class="hidden">
      <div class="toolbar">
        <input id="search" type="search" placeholder="TÃ¬m tá»« hoáº·c nghÄ©a Ä‘Ã£ há»c..." />
        <button id="exportBtn" class="btn">Táº£i CSV táº¥t cáº£ tá»« Ä‘Ã£ há»c</button>
        <button id="clearAll" class="btn warn">XÃ³a Táº¤T Cáº¢ dá»¯ liá»‡u</button>
      </div>
      <div id="learnedList" class="list"></div>
    </section>

    <div class="footer">Dá»¯ liá»‡u lÆ°u trÃªn trÃ¬nh duyá»‡t (localStorage). Tá»« vá»±ng máº«u cÃ³ sáºµn, báº¡n cÃ³ thá»ƒ má»Ÿ rá»™ng trong mÃ£ nguá»“n.</div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script>
    // Cáº¥u hÃ¬nh Firebase cho web app
    const firebaseConfig = {
      apiKey: "AIzaSyCg9wLWjLkwf5mCaRsAcp3obVi-CKXoH-E",
      authDomain: "learning-english-56f73.firebaseapp.com",
      projectId: "learning-english-56f73",
      storageBucket: "learning-english-56f73.appspot.com",
      messagingSenderId: "339132124762",
      appId: "1:339132124762:web:48a113f910f12fd84a1263",
      measurementId: "G-5FB87HKJGY"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    // UI logic cho popup Ä‘Äƒng nháº­p/Ä‘Äƒng kÃ½
    // Popup Ä‘Äƒng nháº­p/Ä‘Äƒng kÃ½, Google sign-in, logout, toast
    (function() {
      const authModal = document.getElementById('authModal');
      const authModalContent = document.getElementById('authModalContent');
      const openAuthBtn = document.getElementById('openAuth');
      const logoutBtn = document.getElementById('logoutBtn');
      const closeAuthBtn = document.getElementById('closeAuth');
      const authForm = document.getElementById('authForm');
      const authEmail = document.getElementById('authEmail');
      const authPassword = document.getElementById('authPassword');
      const toggleAuthMode = document.getElementById('toggleAuthMode');
      const authError = document.getElementById('authError');
      const googleSignIn = document.getElementById('googleSignIn');
      const toast = document.getElementById('toast');
      let isSignUp = false;

      function showModal() {
        authModal.style.display = 'flex';
        authModal.classList.remove('hidden');
      }
      function hideModal() {
        authModal.style.display = 'none';
        authModal.classList.add('hidden');
      }
      function showToast(msg, color) {
        toast.textContent = msg;
        toast.style.display = 'flex';
        toast.style.background = color || '#222';
        setTimeout(()=>{ toast.style.display = 'none'; }, 2200);
      }
      openAuthBtn.onclick = () => {
        showModal();
        authError.textContent = '';
        isSignUp = false;
        toggleAuthMode.textContent = 'ChÆ°a cÃ³ tÃ i khoáº£n? ÄÄƒng kÃ½';
        authForm.querySelector('button[type="submit"]').textContent = 'ÄÄƒng nháº­p';
      };
      closeAuthBtn.onclick = hideModal;
      authModal.onclick = function(e) {
        if (e.target === authModal) hideModal();
      };
      toggleAuthMode.onclick = () => {
        isSignUp = !isSignUp;
        if(isSignUp) {
          toggleAuthMode.textContent = 'ÄÃ£ cÃ³ tÃ i khoáº£n? ÄÄƒng nháº­p';
          authForm.querySelector('button[type="submit"]').textContent = 'ÄÄƒng kÃ½';
        } else {
          toggleAuthMode.textContent = 'ChÆ°a cÃ³ tÃ i khoáº£n? ÄÄƒng kÃ½';
          authForm.querySelector('button[type="submit"]').textContent = 'ÄÄƒng nháº­p';
        }
        authError.textContent = '';
      };
      authForm.onsubmit = async e => {
        e.preventDefault();
        authError.textContent = '';
        const email = authEmail.value.trim();
        const pass = authPassword.value;
        try {
          if(isSignUp) {
            await auth.createUserWithEmailAndPassword(email, pass);
            showToast('ÄÄƒng kÃ½ thÃ nh cÃ´ng!', '#22c55e');
          } else {
            await auth.signInWithEmailAndPassword(email, pass);
            showToast('ÄÄƒng nháº­p thÃ nh cÃ´ng!', '#22c55e');
          }
          hideModal();
        } catch(err) {
          authError.textContent = err.message.replace('Firebase: ', '');
        }
      };
      // Google sign-in
      googleSignIn.onclick = async function() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
          await auth.signInWithPopup(provider);
          showToast('ÄÄƒng nháº­p Google thÃ nh cÃ´ng!', '#22c55e');
          hideModal();
        } catch(err) {
          authError.textContent = err.message.replace('Firebase: ', '');
        }
      };
      // Logout
      logoutBtn.onclick = async function() {
        await auth.signOut();
        showToast('ÄÄƒng xuáº¥t thÃ nh cÃ´ng!', '#60a5fa');
      };
      // Hiá»ƒn thá»‹ nÃºt Ä‘Äƒng nháº­p/Ä‘Äƒng xuáº¥t phÃ¹ há»£p
      auth.onAuthStateChanged(user => {
        if(user) {
          openAuthBtn.style.display = 'none';
          logoutBtn.style.display = 'inline-block';
        } else {
          openAuthBtn.style.display = 'inline-block';
          logoutBtn.style.display = 'none';
        }
      });
    })();
    /******************** Data ********************/
    // Kho tá»« máº«u: {word, phonetic, vi, hint}
    const CORPUS = [
      {w:'abandon', p:'/É™ËˆbÃ¦ndÉ™n/', v:'tá»« bá»; bá» rÆ¡i', h:'They had to abandon the car.'},
      {w:'ability', p:'/É™ËˆbÉªlÉ™ti/', v:'kháº£ nÄƒng', h:'Her ability is impressive.'},
      {w:'accurate', p:'/ËˆÃ¦kjÉ™rÉ™t/', v:'chÃ­nh xÃ¡c', h:'An accurate report.'},
      {w:'achieve', p:'/É™ËˆtÊƒiËv/', v:'Ä‘áº¡t Ä‘Æ°á»£c', h:'Achieve your goals.'},
      {w:'active', p:'/ËˆÃ¦ktÉªv/', v:'nÄƒng Ä‘á»™ng; tÃ­ch cá»±c', h:'An active lifestyle.'},
      {w:'adapt', p:'/É™ËˆdÃ¦pt/', v:'thÃ­ch nghi', h:'Adapt to changes.'},
      {w:'advantage', p:'/É™dËˆvÉ‘ËntÉªdÊ’/', v:'lá»£i tháº¿', h:'Have an advantage.'},
      {w:'afford', p:'/É™ËˆfÉ”Ëd/', v:'cÃ³ Ä‘á»§ kháº£ nÄƒng (chi tráº£)', h:'Can you afford it?'},
      {w:'ambition', p:'/Ã¦mËˆbÉªÊƒn/', v:'tham vá»ng', h:'Great ambition.'},
      {w:'ancient', p:'/ËˆeÉªnÊƒÉ™nt/', v:'cá»• xÆ°a', h:'Ancient city.'},
      {w:'approve', p:'/É™ËˆpruËv/', v:'tÃ¡n thÃ nh; phÃª duyá»‡t', h:'Approve a plan.'},
      {w:'assist', p:'/É™ËˆsÉªst/', v:'há»— trá»£', h:'Assist a customer.'},
      {w:'attempt', p:'/É™Ëˆtempt/', v:'cá»‘ gáº¯ng; thá»­', h:'Attempt to fix it.'},
      {w:'attract', p:'/É™ËˆtrÃ¦kt/', v:'thu hÃºt', h:'Attract attention.'},
      {w:'balance', p:'/ËˆbÃ¦lÉ™ns/', v:'cÃ¢n báº±ng', h:'Work-life balance.'},
      {w:'behave', p:'/bÉªËˆheÉªv/', v:'cÆ° xá»­', h:'Behave well.'},
      {w:'benefit', p:'/ËˆbenÉªfÉªt/', v:'lá»£i Ã­ch; cÃ³ lá»£i', h:'Mutual benefit.'},
      {w:'borrow', p:'/ËˆbÉ’rÉ™ÊŠ/', v:'mÆ°á»£n', h:'Borrow a book.'},
      {w:'brief', p:'/briËf/', v:'ngáº¯n gá»n', h:'A brief meeting.'},
      {w:'capable', p:'/ËˆkeÉªpÉ™bl/', v:'cÃ³ kháº£ nÄƒng', h:'Capable team.'},
      {w:'careful', p:'/ËˆkeÉ™fl/', v:'cáº©n tháº­n', h:'Be careful.'},
      {w:'challenge', p:'/ËˆtÊƒÃ¦lÉªndÊ’/', v:'thá»­ thÃ¡ch', h:'Face a challenge.'},
      {w:'change', p:'/tÊƒeÉªndÊ’/', v:'thay Ä‘á»•i', h:'Change your mind.'},
      {w:'clarify', p:'/ËˆklÃ¦rÉªfaÉª/', v:'lÃ m rÃµ', h:'Clarify a point.'},
      {w:'combine', p:'/kÉ™mËˆbaÉªn/', v:'káº¿t há»£p', h:'Combine ideas.'},
      {w:'commit', p:'/kÉ™ËˆmÉªt/', v:'cam káº¿t; pháº¡m', h:'Commit to learning.'},
      {w:'compare', p:'/kÉ™mËˆpeÉ™(r)/', v:'so sÃ¡nh', h:'Compare prices.'},
      {w:'complete', p:'/kÉ™mËˆpliËt/', v:'hoÃ n thÃ nh', h:'Complete a task.'},
      {w:'confident', p:'/ËˆkÉ’nfÉªdÉ™nt/', v:'tá»± tin', h:'Feel confident.'},
      {w:'consider', p:'/kÉ™nËˆsÉªdÉ™(r)/', v:'cÃ¢n nháº¯c; xem xÃ©t', h:'Consider options.'},
      {w:'create', p:'/kriËˆeÉªt/', v:'táº¡o ra', h:'Create content.'},
      {w:'curious', p:'/ËˆkjÊŠÉ™riÉ™s/', v:'tÃ² mÃ²', h:'A curious child.'},
      {w:'decrease', p:'/dÉªËˆkriËs/', v:'giáº£m', h:'Decrease costs.'},
      {w:'deliver', p:'/dÉªËˆlÉªvÉ™(r)/', v:'giao; trÃ¬nh bÃ y', h:'Deliver a speech.'},
      {w:'depend', p:'/dÉªËˆpend/', v:'phá»¥ thuá»™c', h:'Depend on you.'},
      {w:'design', p:'/dÉªËˆzaÉªn/', v:'thiáº¿t káº¿', h:'Design a logo.'},
      {w:'develop', p:'/dÉªËˆvelÉ™p/', v:'phÃ¡t triá»ƒn', h:'Develop skills.'},
      {w:'education', p:'/ËŒedÊ’uËˆkeÉªÊƒn/', v:'giÃ¡o dá»¥c', h:'Education matters.'},
      {w:'effort', p:'/ËˆefÉ™t/', v:'ná»— lá»±c', h:'Make an effort.'},
      {w:'efficient', p:'/ÉªËˆfÉªÊƒnt/', v:'hiá»‡u quáº£', h:'Efficient system.'},
      {w:'encourage', p:'/ÉªnËˆkÊŒrÉªdÊ’/', v:'khuyáº¿n khÃ­ch', h:'Encourage learning.'},
      {w:'energy', p:'/ËˆenÉ™dÊ’i/', v:'nÄƒng lÆ°á»£ng', h:'Save energy.'},
      {w:'engineer', p:'/ËŒendÊ’ÉªËˆnÉªÉ™(r)/', v:'ká»¹ sÆ°', h:'Software engineer.'},
      {w:'enjoy', p:'/ÉªnËˆdÊ’É”Éª/', v:'thÆ°á»Ÿng thá»©c; thÃ­ch', h:'Enjoy the show.'},
      {w:'environment', p:'/ÉªnËˆvaÉªrÉ™nmÉ™nt/', v:'mÃ´i trÆ°á»ng', h:'Protect the environment.'},
      {w:'evidence', p:'/ËˆevÉªdÉ™ns/', v:'báº±ng chá»©ng', h:'Strong evidence.'},
      {w:'expand', p:'/ÉªkËˆspÃ¦nd/', v:'má»Ÿ rá»™ng', h:'Expand the team.'},
      {w:'experience', p:'/ÉªkËˆspÉªÉ™riÉ™ns/', v:'kinh nghiá»‡m; tráº£i nghiá»‡m', h:'Work experience.'},
      {w:'explain', p:'/ÉªkËˆspleÉªn/', v:'giáº£i thÃ­ch', h:'Explain clearly.'},
      {w:'feature', p:'/ËˆfiËtÊƒÉ™(r)/', v:'tÃ­nh nÄƒng; Ä‘áº·c Ä‘iá»ƒm', h:'New feature.'},
      {w:'focus', p:'/ËˆfÉ™ÊŠkÉ™s/', v:'táº­p trung', h:'Focus on tasks.'},
      {w:'frequent', p:'/ËˆfriËkwÉ™nt/', v:'thÆ°á»ng xuyÃªn', h:'Frequent visits.'}
    ];

    const LS_KEYS = {
      todaySet: 'md5t_today_set',        // {date:'YYYY-MM-DD', items:[indexes]}
      learned: 'md5t_learned',           // [{date, items:[{w,p,v}]}]
      usedIndex: 'md5t_used_indexes',    // number[] to avoid repeat
      streak: 'md5t_streak',
      lastDate: 'md5t_last_date'
    };

    /******************** Utilities ********************/
    const fmtDate = (d=new Date()) => d.toISOString().slice(0,10);
    const today = fmtDate();
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function load(key, fallback){
      try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch{ return fallback }
    }
    function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] }
      return arr;
    }

    /******************** Today set logic ********************/
    function ensureTodaySet(){
      let todaySet = load(LS_KEYS.todaySet, null);
      if(!todaySet || todaySet.date !== today){
        // pick 5 new indices not used yet
        const used = new Set(load(LS_KEYS.usedIndex, []));
        const available = CORPUS.map((_,i)=>i).filter(i=>!used.has(i));
        let picks = [];
        if(available.length >= 5){
          shuffle(available); picks = available.slice(0,5);
        }else{
          // not enough fresh words: include remaining + random from start
          const rest = available.slice();
          const need = 5 - rest.length;
          const pool = CORPUS.map((_,i)=>i);
          shuffle(pool);
          picks = rest.concat(pool.slice(0,need));
        }
        todaySet = {date: today, items: picks};
        save(LS_KEYS.todaySet, todaySet);
      }
      return todaySet;
    }

    function markUsed(indexes){
      const used = new Set(load(LS_KEYS.usedIndex, []));
      indexes.forEach(i=>used.add(i));
      save(LS_KEYS.usedIndex, Array.from(used));
    }

    function updateStreak(){
      const last = load(LS_KEYS.lastDate, null);
      let s = load(LS_KEYS.streak, 0);
      if(last){
        const diff = (new Date(today) - new Date(last))/(1000*3600*24);
        if(diff === 1){ s += 1; }
        else if(diff > 1){ s = 1; }
      }else{ s = 1; }
      save(LS_KEYS.streak, s); save(LS_KEYS.lastDate, today); return s;
    }

    /******************** Render Lesson ********************/
    function renderLesson(){
      const set = ensureTodaySet();
      $('#todayLabel').textContent = 'HÃ´m nay: ' + set.date;
      $('#totalWords').textContent = CORPUS.length;

      const frag = document.createDocumentFragment();
      set.items.forEach((idx, order)=>{
        const it = CORPUS[idx];
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${order+1}. ${it.w}</h3>
          <div class="phonetic">${it.p || ''}</div>
          <div class="meaning"><span class="vi hidden">${it.v}</span>
            <button class="btn reveal">Hiá»‡n nghÄ©a</button>
          </div>
          <div class="muted" style="margin-top:8px">VÃ­ dá»¥: <em>${it.h || ''}</em></div>
        `;
        frag.appendChild(card);
      });
      const root = $('#lesson'); root.innerHTML=''; root.appendChild(frag);
      $$('#lesson .reveal').forEach(btn=>btn.addEventListener('click', e=>{
        const box = e.currentTarget.closest('.meaning');
        box.querySelector('.vi').classList.remove('hidden');
        e.currentTarget.remove();
      }));

      // progress
      const learned = load(LS_KEYS.learned, []);
      const learnedCount = learned.reduce((acc,g)=>acc+g.items.length,0);
      $('#progress').textContent = learnedCount;
      $('#streak').textContent = load(LS_KEYS.streak, 0);
    }

    /******************** Finish Day ********************/
    function finishDay(){
      const set = ensureTodaySet();
      const items = set.items.map(i=>({w:CORPUS[i].w, p:CORPUS[i].p, v:CORPUS[i].v}));
      const learned = load(LS_KEYS.learned, []);
      if(!learned.find(g=>g.date===set.date)){
        learned.push({date:set.date, items});
        save(LS_KEYS.learned, learned);
        markUsed(set.items);
        updateStreak();
        alert('ÄÃ£ lÆ°u 5 tá»« cá»§a ngÃ y ' + set.date + ' vÃ o danh sÃ¡ch Ä‘Ã£ há»c.');
      } else {
        alert('NgÃ y hÃ´m nay Ä‘Ã£ Ä‘Æ°á»£c lÆ°u trÆ°á»›c Ä‘Ã³.');
      }
      renderLesson(); renderLearned();
    }

    /******************** Learned List ********************/
    function renderLearned(){
      const learned = load(LS_KEYS.learned, []);
      const list = $('#learnedList'); list.innerHTML='';
      learned.sort((a,b)=> b.date.localeCompare(a.date));
      learned.forEach(group=>{
        const wrap = document.createElement('details');
        wrap.open = false;
        const tags = group.items.map(it=>`<span class="tag">${it.w} <span style="opacity:.6">(${it.v})</span></span>`).join('');
        wrap.innerHTML = `<summary>${group.date} â€” ${group.items.length} tá»«</summary><div style="margin-top:8px">${tags}</div>`;
        list.appendChild(wrap);
      });
    }

    // Search filter
    $('#search').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      $$('#learnedList details').forEach(d=>{
        if(!q){ d.classList.remove('hidden'); return; }
        const text = d.textContent.toLowerCase();
        d.classList.toggle('hidden', !text.includes(q));
      });
    });

    // Export CSV
    function exportCSV(){
      const learned = load(LS_KEYS.learned, []);
      const rows = [['date','word','phonetic','vi']];
      learned.forEach(g=>g.items.forEach(it=>rows.push([g.date,it.w,it.p||'',it.v])));
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='md5t_learned.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    /******************** Quiz ********************/
    function startQuiz(){
      const set = ensureTodaySet();
      const todayWords = set.items.map(i=>CORPUS[i]);
      if(todayWords.length < 5){ alert('ChÆ°a cÃ³ Ä‘á»§ tá»« cho hÃ´m nay.'); return; }
      const questions = todayWords.map(it=>({
        prompt:`Tá»« nÃ o khá»›p vá»›i nghÄ©a: \"${it.v}\"?`,
        correct: it.w,
        options: shuffle([it.w, ...shuffle(CORPUS.filter(x=>x.w!==it.w)).slice(0,3).map(x=>x.w)])
      }));
      renderQuiz(questions);
    }

    function renderQuiz(questions){
      const quizRoot = $('#quiz'); quizRoot.innerHTML='';
      let score = 0, answered = 0;

      questions.forEach((q, qi)=>{
        const card = document.createElement('div'); card.className='q-card';
        card.innerHTML = `<div><strong>CÃ¢u ${qi+1}</strong>: ${q.prompt}</div>`;
        const choices = document.createElement('div'); choices.className='choices';
        q.options.forEach(opt=>{
          const btn = document.createElement('button'); btn.className='choice'; btn.textContent=opt;
          btn.addEventListener('click',()=>{
            if(btn.classList.contains('correct') || btn.classList.contains('wrong')) return;
            answered++;
            if(opt===q.correct){ btn.classList.add('correct'); score++; }
            else { btn.classList.add('wrong'); [...choices.children].forEach(c=>{ if(c.textContent===q.correct) c.classList.add('correct'); }); }
            if(answered===questions.length){
              const res = document.createElement('div'); res.style.marginTop='14px';
              res.innerHTML = `<div class="card">âœ… HoÃ n thÃ nh! Äiá»ƒm: <strong>${score}/${questions.length}</strong> â€” ${(score*100/questions.length).toFixed(0)}%</div>`;
              quizRoot.appendChild(res);
            }
          });
          choices.appendChild(btn);
        });
        card.appendChild(choices); quizRoot.appendChild(card);
      });
    }

    /******************** Tabs & Actions ********************/
    function switchTab(name){
      $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
      ['lesson','practice','learned'].forEach(id=>{
        $('#tab-'+id).classList.toggle('hidden', id!==name);
      });
    }

    $$('.tab').forEach(btn=>btn.addEventListener('click',()=>switchTab(btn.dataset.tab)));
    $('#finishDay').addEventListener('click', finishDay);
    $('#resetToday').addEventListener('click', ()=>{
      if(confirm('Chá»n láº¡i 5 tá»« hÃ´m nay? (KhÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n cÃ¡c ngÃ y Ä‘Ã£ lÆ°u)')){
        localStorage.removeItem(LS_KEYS.todaySet);
        renderLesson(); // regenerate
      }
    });
    $('#exportBtn').addEventListener('click', exportCSV);
    $('#clearAll').addEventListener('click', ()=>{
      if(confirm('XÃ“A Táº¤T Cáº¢ dá»¯ liá»‡u (bÃ i há»c, tiáº¿n Ä‘á»™, streak)?')){
        Object.values(LS_KEYS).forEach(k=>localStorage.removeItem(k));
        location.reload();
      }
    });
    $('#startQuiz').addEventListener('click', startQuiz);

    /******************** Init ********************/
    function init(){
      // Initialize streak on first finishDay, not on first load
      renderLesson();
      renderLearned();
    }
    init();
  </script>
</body>
</html>
